---
# AnalysisTemplate: Success Rate Analysis
# Monitors HTTP success rate via Prometheus metrics
# Used by: All rollouts (blue/green and canary)
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate-analysis
  labels:
    analysis-type: success-rate
    part-of: teei-csr-platform
spec:
  args:
  - name: service-name
    description: "Service name to monitor"
  - name: error-threshold
    description: "Maximum error rate percentage (e.g., '1' for <1% errors)"
    value: "1"

  metrics:
  - name: http-success-rate
    interval: 30s
    successCondition: result >= (100 - {{args.error-threshold}})
    failureLimit: 3
    count: 10
    provider:
      prometheus:
        address: http://prometheus-server.monitoring.svc.cluster.local:9090
        query: |
          # Success rate: (2xx + 3xx responses) / total requests * 100
          (
            sum(rate(http_requests_total{service="{{args.service-name}}",status=~"2..|3.."}[5m]))
            /
            sum(rate(http_requests_total{service="{{args.service-name}}"}[5m]))
          ) * 100

  - name: http-5xx-rate
    interval: 30s
    successCondition: result < {{args.error-threshold}}
    failureLimit: 2
    count: 10
    provider:
      prometheus:
        address: http://prometheus-server.monitoring.svc.cluster.local:9090
        query: |
          # 5xx error rate percentage
          (
            sum(rate(http_requests_total{service="{{args.service-name}}",status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total{service="{{args.service-name}}"}[5m]))
          ) * 100

  - name: http-4xx-rate
    interval: 30s
    successCondition: result < 10  # <10% 4xx errors (client errors acceptable)
    failureLimit: 2
    count: 10
    provider:
      prometheus:
        address: http://prometheus-server.monitoring.svc.cluster.local:9090
        query: |
          # 4xx error rate percentage
          (
            sum(rate(http_requests_total{service="{{args.service-name}}",status=~"4.."}[5m]))
            /
            sum(rate(http_requests_total{service="{{args.service-name}}"}[5m]))
          ) * 100

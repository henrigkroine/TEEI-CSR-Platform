---
# EU Region-specific mTLS configuration
# Separate trust domain for data residency compliance

apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: eu-mtls-strict
  namespace: default
spec:
  mtls:
    mode: STRICT  # EU production: strict mode
---
# Update Istio control plane for EU region
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: teei-istio-controlplane
  namespace: istio-system
spec:
  meshConfig:
    trustDomain: eu.cluster.local  # EU region trust domain
    mtls:
      mode: STRICT

  values:
    global:
      multiCluster:
        clusterName: eu-secondary
        enabled: true  # Multi-cluster with US region
---
# EU gateway with GDPR compliance
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: teei-gateway
  namespace: istio-system
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - "teei.eu.example.com"
    - "*.teei.eu.example.com"
    tls:
      mode: SIMPLE
      credentialName: teei-platform-tls-eu
      minProtocolVersion: TLSV1_3
      cipherSuites:
        - ECDHE-ECDSA-AES256-GCM-SHA384  # GDPR-compliant strong ciphers
---
# Cross-region ServiceEntry (EU to US)
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: us-region-services
  namespace: istio-system
  labels:
    region: us
spec:
  hosts:
  - "*.us.cluster.local"
  location: MESH_INTERNAL
  ports:
  - number: 15443
    name: tls
    protocol: TLS
  resolution: DNS
  endpoints:
  - address: istio-ingressgateway.us-region.example.com
    ports:
      tls: 15443
---
# Allow cross-region calls from US
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-cross-region-us-to-eu
  namespace: default
spec:
  selector:
    matchLabels:
      cross-region-enabled: "true"
  action: ALLOW
  rules:
  - from:
    - source:
        principals:
        - "us.cluster.local/ns/default/sa/*"
    to:
    - operation:
        methods: ["GET", "POST"]

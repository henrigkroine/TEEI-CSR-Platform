---
# EU Central 1 - Replica Database Configuration
# This overlay configures PostgreSQL as the REPLICA instance

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  labels:
    region: eu-central-1
    role: replica
spec:
  replicas: 1
  template:
    metadata:
      labels:
        region: eu-central-1
        role: replica
      annotations:
        replication.postgres/role: replica
        replication.postgres/region: eu-central-1
        replication.postgres/primary: postgres-primary-us.teei.internal
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: topology.kubernetes.io/region
                    operator: In
                    values:
                      - eu-central-1
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - postgres
                topologyKey: kubernetes.io/hostname
      containers:
        - name: postgres
          env:
            - name: POSTGRES_ROLE
              value: "replica"
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
            - name: PRIMARY_HOST
              value: "postgres-primary-us.teei.internal"
            - name: REPLICATION_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: REPLICATION_USER
            - name: REPLICATION_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: REPLICATION_PASSWORD
          # Additional replica-specific configuration
          command:
            - sh
            - -c
            - |
              # Set cluster region for tracking
              export PGDATA=/var/lib/postgresql/data/pgdata

              # Start PostgreSQL
              docker-entrypoint.sh postgres \
                -c config_file=/etc/postgresql/postgresql.conf \
                -c hba_file=/etc/postgresql/pg_hba.conf
  volumeClaimTemplates:
    - metadata:
        name: postgres-data
        labels:
          region: eu-central-1
      spec:
        storageClassName: gp3
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 150Gi  # Smaller for replica (EU data only)
---
# Service patch for EU Central 1
apiVersion: v1
kind: Service
metadata:
  name: postgres-replica
  labels:
    region: eu-central-1
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-internal: "true"
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    external-dns.alpha.kubernetes.io/hostname: postgres-replica-eu.teei.internal
spec:
  selector:
    app: postgres
    role: replica
    region: eu-central-1
---
# ConfigMap for EU-specific PostgreSQL settings
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-eu-config
  labels:
    region: eu-central-1
data:
  # EU-specific settings
  replica.conf: |
    # Read-only replica configuration
    hot_standby = on
    hot_standby_feedback = on
    max_standby_streaming_delay = 30s

    # GDPR compliance logging
    log_statement = 'ddl'
    log_min_duration_statement = 500

    # EU data residency enforcement
    # Note: Application-level enforcement is primary
    cluster.region = 'eu-central-1'
    cluster.data_residency = 'eu'

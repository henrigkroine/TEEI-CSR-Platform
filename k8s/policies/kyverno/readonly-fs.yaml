apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-readonly-filesystem
  annotations:
    policies.kyverno.io/title: Require Read-Only Root Filesystem
    policies.kyverno.io/category: Pod Security Standards (Restricted)
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Read-only root filesystems prevent containers from writing to their
      filesystem, reducing the attack surface and preventing malware persistence.
      Exceptions are granted for stateful workloads (databases, caches) that
      require filesystem writes. Applications needing temporary storage should
      use emptyDir volumes.
spec:
  validationFailureAction: audit  # Start in audit mode, switch to enforce after validation
  background: true
  rules:
    - name: require-readonly-rootfs
      match:
        any:
        - resources:
            kinds:
              - Pod
      exclude:
        any:
        - resources:
            namespaces:
              - database
              - postgres
              - mysql
              - mongodb
              - redis
              - elasticsearch
            selector:
              matchLabels:
                app.kubernetes.io/component: database
        - resources:
            selector:
              matchLabels:
                stateful: "true"
      validate:
        message: >-
          Containers must use read-only root filesystem (readOnlyRootFilesystem: true).
          This prevents runtime modifications and improves security. If your application
          needs to write temporary files, use an emptyDir volume mounted at the required path.
          Stateful workloads (databases) can request an exception via labels.
        pattern:
          spec:
            =(ephemeralContainers):
              - =(securityContext):
                  readOnlyRootFilesystem: true
            =(initContainers):
              - =(securityContext):
                  readOnlyRootFilesystem: true
            containers:
              - securityContext:
                  readOnlyRootFilesystem: true

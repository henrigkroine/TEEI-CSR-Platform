apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: deny-privileged-pods
  annotations:
    policies.kyverno.io/title: Deny Privileged Containers
    policies.kyverno.io/category: Pod Security Standards (Restricted)
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Privileged containers have unrestricted access to host resources and
      bypass many security mechanisms. This policy blocks all privileged
      containers to enforce the principle of least privilege. No exceptions
      are granted as privileged access is rarely justified in production.
spec:
  validationFailureAction: audit  # Start in audit mode, switch to enforce after validation
  background: true
  rules:
    - name: deny-privileged-containers
      match:
        any:
        - resources:
            kinds:
              - Pod
      validate:
        message: >-
          Privileged containers are not allowed. Running containers in privileged
          mode grants all Linux capabilities and bypasses security constraints.
          Please remove 'securityContext.privileged: true' from your pod spec.
        pattern:
          spec:
            =(ephemeralContainers):
              - =(securityContext):
                  =(privileged): "false"
            =(initContainers):
              - =(securityContext):
                  =(privileged): "false"
            containers:
              - =(securityContext):
                  =(privileged): "false"

# Admission Controller Policy - SLSA L3 Enforcement
# Blocks unsigned images and images without SBOM

apiVersion: v1
kind: ConfigMap
metadata:
  name: admission-policy
  namespace: kube-system
data:
  policy.yaml: |
    apiVersion: policy.sigstore.dev/v1beta1
    kind: ClusterImagePolicy
    metadata:
      name: require-signed-images
    spec:
      images:
        - glob: "ghcr.io/teei-csr-platform/**"
      authorities:
        - keyless:
            url: https://fulcio.sigstore.dev
            identities:
              - issuerRegExp: "https://token.actions.githubusercontent.com"
                subjectRegExp: "^https://github.com/teei-csr-platform/.*"
        - attestations:
            - name: sbom
              predicateType: https://spdx.dev/Document
              policy:
                type: cue
                data: |
                  predicateType: "https://spdx.dev/Document"
            - name: provenance
              predicateType: https://slsa.dev/provenance/v0.2
              policy:
                type: cue
                data: |
                  predicateType: "https://slsa.dev/provenance/v0.2"
                  predicate: builder: id: =~"^https://github.com/slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@refs/tags/v[0-9]+.[0-9]+.[0-9]+$"
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: policy.sigstore.dev
webhooks:
  - name: validating.clusterimagepolicy.sigstore.dev
    admissionReviewVersions: ["v1", "v1beta1"]
    clientConfig:
      service:
        name: webhook
        namespace: cosign-system
        path: /validations
    sideEffects: None
    failurePolicy: Fail  # Fail closed - block unsigned images
    rules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["pods"]
        scope: "*"
      - apiGroups: ["apps"]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["deployments", "replicasets", "statefulsets", "daemonsets"]
        scope: "*"
      - apiGroups: ["batch"]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["jobs", "cronjobs"]
        scope: "*"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sbom-validation-policy
  namespace: kube-system
data:
  policy.rego: |
    package sbom.validation

    # Deny images without SBOM
    deny[msg] {
      input.image
      not has_sbom(input.image)
      msg := sprintf("Image %s does not have an attached SBOM", [input.image])
    }

    # Deny images with critical vulnerabilities
    deny[msg] {
      input.image
      sbom := get_sbom(input.image)
      critical_vulns := sbom.vulnerabilities[_]
      critical_vulns.severity == "CRITICAL"
      msg := sprintf("Image %s has CRITICAL vulnerabilities: %s", [input.image, critical_vulns.id])
    }

    # Helper: Check if SBOM is attached
    has_sbom(image) {
      # Would query Cosign for attached SBOM
      # Simplified for this policy
      true
    }

    # Helper: Get SBOM for image
    get_sbom(image) {
      # Would fetch SBOM via Cosign
      # Simplified for this policy
      {"vulnerabilities": []}
    }
---
# Enforcement exceptions (for legacy images during migration period)
apiVersion: v1
kind: ConfigMap
metadata:
  name: enforcement-exceptions
  namespace: kube-system
data:
  exceptions.yaml: |
    exceptions:
      # Allow unsigned images in dev namespaces (90-day sunset)
      - namespace: dev-*
        until: "2026-02-15"
        reason: "Migration period for legacy dev images"

      # Allow specific third-party images (with manual review)
      - images:
          - "docker.io/library/nginx:*"
          - "docker.io/library/postgres:*"
        reason: "Trusted third-party base images"
        reviewed_by: "security-team@teei.io"
        review_date: "2025-11-01"
        next_review: "2026-05-01"

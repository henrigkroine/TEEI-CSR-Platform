apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: teei-reporting-scaler
  labels:
    app: teei-reporting
    component: autoscaling
    part-of: teei-csr-platform
    managed-by: keda
spec:
  scaleTargetRef:
    name: teei-reporting
  minReplicaCount: 3
  maxReplicaCount: 15
  cooldownPeriod: 30
  pollingInterval: 10
  advanced:
    restoreToOriginalReplicaCount: false
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 300  # 5 minutes scale-down delay
          policies:
            - type: Percent
              value: 50
              periodSeconds: 60
            - type: Pods
              value: 2
              periodSeconds: 60
          selectPolicy: Min
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
            - type: Percent
              value: 100
              periodSeconds: 30  # Scale-up latency <30s
            - type: Pods
              value: 3
              periodSeconds: 30
          selectPolicy: Max
  triggers:
    - type: prometheus
      metadata:
        # Prometheus server endpoint
        serverAddress: http://prometheus-server.observability.svc.cluster.local:9090
        # Query for request rate per second
        # This calculates the rate of HTTP requests over the last 1 minute
        query: |
          sum(rate(http_requests_total{service="teei-reporting"}[1m]))
        # Threshold: 50 requests/second
        threshold: "50"
        # Activation threshold: start scaling when we have at least 10 req/s
        activationThreshold: "10"
---
# Alternative: HTTP request scaler using metrics-server
# Uncomment if you prefer to use direct HTTP metrics instead of Prometheus
#
# apiVersion: keda.sh/v1alpha1
# kind: ScaledObject
# metadata:
#   name: teei-reporting-scaler-http
#   labels:
#     app: teei-reporting
#     component: autoscaling
#     part-of: teei-csr-platform
#     managed-by: keda
# spec:
#   scaleTargetRef:
#     name: teei-reporting
#   minReplicaCount: 3
#   maxReplicaCount: 15
#   cooldownPeriod: 30
#   pollingInterval: 10
#   advanced:
#     restoreToOriginalReplicaCount: false
#     horizontalPodAutoscalerConfig:
#       behavior:
#         scaleDown:
#           stabilizationWindowSeconds: 300
#           policies:
#             - type: Percent
#               value: 50
#               periodSeconds: 60
#           selectPolicy: Min
#         scaleUp:
#           stabilizationWindowSeconds: 0
#           policies:
#             - type: Percent
#               value: 100
#               periodSeconds: 30
#           selectPolicy: Max
#   triggers:
#     - type: metrics-api
#       metadata:
#         targetValue: "50"
#         url: "http://teei-reporting.default.svc.cluster.local:3014/metrics/request-rate"
#         valueLocation: "value"
#         method: "query"

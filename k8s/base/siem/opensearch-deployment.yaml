apiVersion: v1
kind: Namespace
metadata:
  name: siem
  labels:
    app.kubernetes.io/name: siem
    security: enabled
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: opensearch-config
  namespace: siem
data:
  opensearch.yml: |
    cluster.name: teei-siem-cluster
    network.host: 0.0.0.0

    # Security settings
    plugins.security.ssl.transport.pemcert_filepath: certs/tls.crt
    plugins.security.ssl.transport.pemkey_filepath: certs/tls.key
    plugins.security.ssl.transport.pemtrustedcas_filepath: certs/ca.crt
    plugins.security.ssl.http.enabled: true
    plugins.security.ssl.http.pemcert_filepath: certs/tls.crt
    plugins.security.ssl.http.pemkey_filepath: certs/tls.key
    plugins.security.ssl.http.pemtrustedcas_filepath: certs/ca.crt
    plugins.security.allow_unsafe_democertificates: false
    plugins.security.authcz.admin_dn:
      - CN=admin,O=TEEI,C=US

    # Node roles
    node.roles: [ data, master, ingest ]

    # Discovery
    discovery.seed_hosts:
      - opensearch-0.opensearch-headless.siem.svc.cluster.local
      - opensearch-1.opensearch-headless.siem.svc.cluster.local
      - opensearch-2.opensearch-headless.siem.svc.cluster.local
    cluster.initial_master_nodes:
      - opensearch-0
      - opensearch-1
      - opensearch-2

    # Performance
    bootstrap.memory_lock: true

    # Index management
    action.auto_create_index: true

  log4j2.properties: |
    status = error
    appender.console.type = Console
    appender.console.name = console
    appender.console.layout.type = PatternLayout
    appender.console.layout.pattern = [%d{ISO8601}][%-5p][%-25c{1.}] %marker%m%n
    rootLogger.level = info
    rootLogger.appenderRef.console.ref = console
---
apiVersion: v1
kind: Service
metadata:
  name: opensearch
  namespace: siem
  labels:
    app: opensearch
spec:
  type: ClusterIP
  ports:
    - port: 9200
      name: http
      targetPort: 9200
    - port: 9300
      name: transport
      targetPort: 9300
  selector:
    app: opensearch
---
apiVersion: v1
kind: Service
metadata:
  name: opensearch-headless
  namespace: siem
  labels:
    app: opensearch
spec:
  clusterIP: None
  ports:
    - port: 9200
      name: http
    - port: 9300
      name: transport
  selector:
    app: opensearch
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: opensearch
  namespace: siem
spec:
  serviceName: opensearch-headless
  replicas: 3
  selector:
    matchLabels:
      app: opensearch
  template:
    metadata:
      labels:
        app: opensearch
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9200"
        prometheus.io/path: "/_prometheus/metrics"
    spec:
      securityContext:
        fsGroup: 1000
      initContainers:
        - name: increase-vm-max-map
          image: busybox:1.36
          command: ["sysctl", "-w", "vm.max_map_count=262144"]
          securityContext:
            privileged: true
        - name: increase-fd-ulimit
          image: busybox:1.36
          command: ["sh", "-c", "ulimit -n 65536"]
          securityContext:
            privileged: true
      containers:
        - name: opensearch
          image: opensearchproject/opensearch:2.11.1
          env:
            - name: cluster.name
              value: teei-siem-cluster
            - name: node.name
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: OPENSEARCH_JAVA_OPTS
              value: "-Xms4g -Xmx4g"
            - name: DISABLE_INSTALL_DEMO_CONFIG
              value: "true"
            - name: DISABLE_SECURITY_PLUGIN
              value: "false"
          resources:
            requests:
              cpu: "2"
              memory: "8Gi"
            limits:
              cpu: "4"
              memory: "8Gi"
          ports:
            - containerPort: 9200
              name: http
            - containerPort: 9300
              name: transport
          volumeMounts:
            - name: data
              mountPath: /usr/share/opensearch/data
            - name: config
              mountPath: /usr/share/opensearch/config/opensearch.yml
              subPath: opensearch.yml
            - name: certs
              mountPath: /usr/share/opensearch/config/certs
              readOnly: true
          livenessProbe:
            httpGet:
              path: /_cluster/health
              port: 9200
              scheme: HTTPS
            initialDelaySeconds: 90
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /_cluster/health
              port: 9200
              scheme: HTTPS
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
      volumes:
        - name: config
          configMap:
            name: opensearch-config
        - name: certs
          secret:
            secretName: opensearch-certs
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: [ "ReadWriteOnce" ]
        storageClassName: fast-ssd
        resources:
          requests:
            storage: 500Gi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: opensearch-ism-policies
  namespace: siem
data:
  hot-warm-cold-delete.json: |
    {
      "policy": {
        "description": "Hot-Warm-Cold-Delete policy for security logs",
        "default_state": "hot",
        "states": [
          {
            "name": "hot",
            "actions": [],
            "transitions": [
              {
                "state_name": "warm",
                "conditions": {
                  "min_index_age": "7d"
                }
              }
            ]
          },
          {
            "name": "warm",
            "actions": [
              {
                "replica_count": {
                  "number_of_replicas": 1
                }
              }
            ],
            "transitions": [
              {
                "state_name": "cold",
                "conditions": {
                  "min_index_age": "30d"
                }
              }
            ]
          },
          {
            "name": "cold",
            "actions": [
              {
                "replica_count": {
                  "number_of_replicas": 0
                }
              }
            ],
            "transitions": [
              {
                "state_name": "delete",
                "conditions": {
                  "min_index_age": "90d"
                }
              }
            ]
          },
          {
            "name": "delete",
            "actions": [
              {
                "delete": {}
              }
            ],
            "transitions": []
          }
        ]
      }
    }
---
apiVersion: batch/v1
kind: Job
metadata:
  name: opensearch-setup
  namespace: siem
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: setup
          image: curlimages/curl:8.4.0
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Waiting for OpenSearch to be ready..."
              until curl -k -u admin:admin https://opensearch.siem.svc.cluster.local:9200/_cluster/health?wait_for_status=yellow&timeout=50s; do
                echo "Waiting..."
                sleep 5
              done

              echo "Creating index templates..."

              # Security events index template
              curl -k -X PUT "https://opensearch.siem.svc.cluster.local:9200/_index_template/security-events" \
                -u admin:admin \
                -H 'Content-Type: application/json' \
                -d '{
                  "index_patterns": ["security-events-*"],
                  "template": {
                    "settings": {
                      "number_of_shards": 3,
                      "number_of_replicas": 2,
                      "index.lifecycle.name": "hot-warm-cold-delete"
                    },
                    "mappings": {
                      "properties": {
                        "@timestamp": {"type": "date"},
                        "event_type": {"type": "keyword"},
                        "severity": {"type": "keyword"},
                        "source_ip": {"type": "ip"},
                        "user": {"type": "keyword"},
                        "service": {"type": "keyword"},
                        "namespace": {"type": "keyword"},
                        "region": {"type": "keyword"},
                        "message": {"type": "text"},
                        "metadata": {"type": "object"}
                      }
                    }
                  }
                }'

              # Authentication events index template
              curl -k -X PUT "https://opensearch.siem.svc.cluster.local:9200/_index_template/auth-events" \
                -u admin:admin \
                -H 'Content-Type: application/json' \
                -d '{
                  "index_patterns": ["auth-events-*"],
                  "template": {
                    "settings": {
                      "number_of_shards": 3,
                      "number_of_replicas": 2
                    },
                    "mappings": {
                      "properties": {
                        "@timestamp": {"type": "date"},
                        "event_type": {"type": "keyword"},
                        "username": {"type": "keyword"},
                        "source_ip": {"type": "ip"},
                        "success": {"type": "boolean"},
                        "mfa_used": {"type": "boolean"},
                        "user_agent": {"type": "text"},
                        "session_id": {"type": "keyword"}
                      }
                    }
                  }
                }'

              # Data access events index template
              curl -k -X PUT "https://opensearch.siem.svc.cluster.local:9200/_index_template/data-access-events" \
                -u admin:admin \
                -H 'Content-Type: application/json' \
                -d '{
                  "index_patterns": ["data-access-*"],
                  "template": {
                    "settings": {
                      "number_of_shards": 3,
                      "number_of_replicas": 2
                    },
                    "mappings": {
                      "properties": {
                        "@timestamp": {"type": "date"},
                        "user": {"type": "keyword"},
                        "query_type": {"type": "keyword"},
                        "table": {"type": "keyword"},
                        "pii_accessed": {"type": "boolean"},
                        "row_count": {"type": "long"},
                        "export_size_bytes": {"type": "long"},
                        "region": {"type": "keyword"},
                        "compliance_tags": {"type": "keyword"}
                      }
                    }
                  }
                }'

              echo "Index templates created successfully"

---
# Destination Rules - Traffic policies for services
# Enforces mTLS on the client side

# Global default: use mTLS for all services
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: default-mtls
  namespace: istio-system  # Global rule
  labels:
    part-of: teei-csr-platform
spec:
  host: "*.local"  # Applied to all services in cluster
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL  # Use Istio mutual TLS
---
# API Gateway traffic policy
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: teei-api-gateway
  namespace: default
spec:
  host: teei-api-gateway.default.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    connectionPool:
      tcp:
        maxConnections: 1000
      http:
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
        maxRequestsPerConnection: 2
    loadBalancer:
      simple: LEAST_REQUEST  # Load balancing algorithm
    outlierDetection:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
---
# Reporting service traffic policy
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: teei-reporting
  namespace: default
spec:
  host: teei-reporting.default.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    connectionPool:
      tcp:
        maxConnections: 500
      http:
        http2MaxRequests: 500
    loadBalancer:
      consistentHash:  # Sticky sessions for report generation
        httpHeaderName: X-Session-Id
---
# Q2Q AI service traffic policy
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: teei-q2q-ai
  namespace: default
spec:
  host: teei-q2q-ai.default.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    connectionPool:
      tcp:
        maxConnections: 200
        connectTimeout: 10s
      http:
        http2MaxRequests: 200
        idleTimeout: 300s  # Long timeout for AI processing
---
# Analytics service traffic policy
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: teei-analytics
  namespace: default
spec:
  host: teei-analytics.default.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    connectionPool:
      tcp:
        maxConnections: 500
      http:
        http2MaxRequests: 500
---
# PostgreSQL traffic policy (if using sidecar)
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: postgresql
  namespace: default
spec:
  host: postgresql.default.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    connectionPool:
      tcp:
        maxConnections: 1000
        connectTimeout: 5s
    loadBalancer:
      simple: ROUND_ROBIN
---
# ClickHouse traffic policy
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: clickhouse
  namespace: default
spec:
  host: clickhouse.default.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    connectionPool:
      tcp:
        maxConnections: 500
      http:
        http2MaxRequests: 500
---
# NATS traffic policy
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: nats
  namespace: default
spec:
  host: nats.default.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    connectionPool:
      tcp:
        maxConnections: 2000  # High concurrency for message bus
---
# Cross-region destination rule (for multi-region mesh)
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: cross-region-eu
  namespace: default
spec:
  host: "*.eu.cluster.local"  # Services in EU region
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 10s  # Longer timeout for cross-region
      http:
        http2MaxRequests: 100
        idleTimeout: 120s

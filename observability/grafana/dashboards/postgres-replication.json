{
  "dashboard": {
    "title": "TEEI Platform - PostgreSQL Cross-Region Replication",
    "description": "Monitors PostgreSQL logical replication between US East 1 (primary) and EU Central 1 (replica)",
    "tags": ["teei", "database", "postgresql", "replication", "disaster-recovery", "multi-region"],
    "timezone": "utc",
    "editable": true,
    "graphTooltip": 1,
    "links": [],
    "panels": [
      {
        "id": 1,
        "title": "Replication Overview",
        "type": "row",
        "collapsed": false,
        "gridPos": {
          "h": 1,
          "w": 24,
          "x": 0,
          "y": 0
        }
      },
      {
        "id": 2,
        "title": "Replication Lag (Seconds)",
        "description": "Time lag between primary and replica. Target: <5 seconds. Alert: >30 seconds.",
        "type": "graph",
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 0,
          "y": 1
        },
        "targets": [
          {
            "expr": "pg_replication_lag_seconds{application_name=~\"teei.*\"}",
            "legendFormat": "{{client_addr}} - {{application_name}} - {{state}}",
            "refId": "A"
          }
        ],
        "yAxes": [
          {
            "label": "Lag (seconds)",
            "format": "s",
            "logBase": 1,
            "min": 0
          }
        ],
        "alert": {
          "conditions": [
            {
              "evaluator": {
                "params": [30],
                "type": "gt"
              },
              "operator": {
                "type": "and"
              },
              "query": {
                "params": ["A", "5m", "now"]
              },
              "reducer": {
                "params": [],
                "type": "avg"
              },
              "type": "query"
            }
          ],
          "executionErrorState": "alerting",
          "frequency": "1m",
          "handler": 1,
          "name": "Replication Lag High",
          "noDataState": "alerting",
          "notifications": []
        },
        "thresholds": [
          {
            "value": 5,
            "colorMode": "custom",
            "fill": true,
            "line": true,
            "op": "gt"
          },
          {
            "value": 30,
            "colorMode": "custom",
            "fill": true,
            "line": true,
            "op": "gt"
          }
        ]
      },
      {
        "id": 3,
        "title": "Replication Lag (Bytes)",
        "description": "WAL byte difference between primary and replica",
        "type": "graph",
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 12,
          "y": 1
        },
        "targets": [
          {
            "expr": "pg_replication_lag_bytes{application_name=~\"teei.*\"}",
            "legendFormat": "{{client_addr}} - {{application_name}}",
            "refId": "A"
          }
        ],
        "yAxes": [
          {
            "label": "Lag (bytes)",
            "format": "bytes",
            "logBase": 1,
            "min": 0
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "bytes"
          }
        }
      },
      {
        "id": 4,
        "title": "Replication Status",
        "description": "Current status of all replication connections",
        "type": "stat",
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 0,
          "y": 9
        },
        "targets": [
          {
            "expr": "count(pg_replication_lag_seconds{application_name=~\"teei.*\", state=\"streaming\"})",
            "legendFormat": "Active Replicas",
            "refId": "A"
          }
        ],
        "options": {
          "colorMode": "value",
          "graphMode": "none",
          "justifyMode": "auto",
          "orientation": "auto",
          "reduceOptions": {
            "values": false,
            "calcs": ["lastNotNull"],
            "fields": ""
          },
          "textMode": "auto"
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {
                  "value": null,
                  "color": "red"
                },
                {
                  "value": 1,
                  "color": "green"
                }
              ]
            }
          }
        }
      },
      {
        "id": 5,
        "title": "Current Lag (Last Value)",
        "description": "Most recent replication lag measurement",
        "type": "stat",
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 6,
          "y": 9
        },
        "targets": [
          {
            "expr": "pg_replication_lag_seconds{application_name=~\"teei.*\"}",
            "legendFormat": "{{application_name}}",
            "refId": "A"
          }
        ],
        "options": {
          "colorMode": "background",
          "graphMode": "area",
          "justifyMode": "auto",
          "orientation": "auto",
          "reduceOptions": {
            "values": false,
            "calcs": ["lastNotNull"],
            "fields": ""
          },
          "textMode": "value_and_name"
        },
        "fieldConfig": {
          "defaults": {
            "unit": "s",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {
                  "value": null,
                  "color": "green"
                },
                {
                  "value": 5,
                  "color": "yellow"
                },
                {
                  "value": 30,
                  "color": "red"
                }
              ]
            }
          }
        }
      },
      {
        "id": 6,
        "title": "Replication Slots Active",
        "description": "Number of active replication slots",
        "type": "stat",
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 12,
          "y": 9
        },
        "targets": [
          {
            "expr": "sum(pg_replication_slots_active)",
            "legendFormat": "Active Slots",
            "refId": "A"
          }
        ],
        "options": {
          "colorMode": "value",
          "graphMode": "area",
          "justifyMode": "auto",
          "orientation": "auto",
          "reduceOptions": {
            "values": false,
            "calcs": ["lastNotNull"],
            "fields": ""
          },
          "textMode": "auto"
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {
                  "value": null,
                  "color": "red"
                },
                {
                  "value": 1,
                  "color": "green"
                }
              ]
            }
          }
        }
      },
      {
        "id": 7,
        "title": "Subscription Health",
        "description": "Health status of subscriptions (1=healthy, 0=unhealthy)",
        "type": "stat",
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 18,
          "y": 9
        },
        "targets": [
          {
            "expr": "pg_subscription_status_streaming{subname=~\"teei.*\"}",
            "legendFormat": "{{subname}}",
            "refId": "A"
          }
        ],
        "options": {
          "colorMode": "background",
          "graphMode": "none",
          "justifyMode": "auto",
          "orientation": "auto",
          "reduceOptions": {
            "values": false,
            "calcs": ["lastNotNull"],
            "fields": ""
          },
          "textMode": "value_and_name"
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {
                  "value": null,
                  "color": "red"
                },
                {
                  "value": 1,
                  "color": "green"
                }
              ]
            },
            "mappings": [
              {
                "type": "value",
                "options": {
                  "0": {
                    "text": "Unhealthy"
                  },
                  "1": {
                    "text": "Healthy"
                  }
                }
              }
            ]
          }
        }
      },
      {
        "id": 8,
        "title": "WAL & Slots",
        "type": "row",
        "collapsed": false,
        "gridPos": {
          "h": 1,
          "w": 24,
          "x": 0,
          "y": 13
        }
      },
      {
        "id": 9,
        "title": "WAL Generation Rate",
        "description": "Rate of Write-Ahead Log generation on primary",
        "type": "graph",
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 0,
          "y": 14
        },
        "targets": [
          {
            "expr": "rate(pg_wal_generation_wal_bytes_generated[5m])",
            "legendFormat": "WAL Generation Rate",
            "refId": "A"
          }
        ],
        "yAxes": [
          {
            "label": "Bytes/sec",
            "format": "Bps",
            "logBase": 1,
            "min": 0
          }
        ]
      },
      {
        "id": 10,
        "title": "Replication Slot Retained WAL",
        "description": "Amount of WAL retained by each replication slot",
        "type": "graph",
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 12,
          "y": 14
        },
        "targets": [
          {
            "expr": "pg_replication_slots_retained_bytes{slot_type=\"logical\"}",
            "legendFormat": "{{slot_name}} - {{database}}",
            "refId": "A"
          }
        ],
        "yAxes": [
          {
            "label": "Retained WAL",
            "format": "bytes",
            "logBase": 1,
            "min": 0
          }
        ],
        "alert": {
          "conditions": [
            {
              "evaluator": {
                "params": [1073741824],
                "type": "gt"
              },
              "operator": {
                "type": "and"
              },
              "query": {
                "params": ["A", "5m", "now"]
              },
              "reducer": {
                "params": [],
                "type": "avg"
              },
              "type": "query"
            }
          ],
          "executionErrorState": "alerting",
          "frequency": "5m",
          "handler": 1,
          "name": "WAL Retention High (>1GB)",
          "noDataState": "no_data",
          "notifications": []
        }
      },
      {
        "id": 11,
        "title": "Replication Slots Table",
        "description": "Detailed view of all replication slots",
        "type": "table",
        "gridPos": {
          "h": 8,
          "w": 24,
          "x": 0,
          "y": 22
        },
        "targets": [
          {
            "expr": "pg_replication_slots_active",
            "format": "table",
            "instant": true,
            "refId": "A"
          },
          {
            "expr": "pg_replication_slots_retained_bytes",
            "format": "table",
            "instant": true,
            "refId": "B"
          }
        ],
        "transformations": [
          {
            "id": "merge",
            "options": {}
          }
        ],
        "options": {
          "showHeader": true,
          "sortBy": [
            {
              "displayName": "slot_name",
              "desc": false
            }
          ]
        }
      },
      {
        "id": 12,
        "title": "Data Residency",
        "type": "row",
        "collapsed": false,
        "gridPos": {
          "h": 1,
          "w": 24,
          "x": 0,
          "y": 30
        }
      },
      {
        "id": 13,
        "title": "Database Size by Region",
        "description": "Total database size in each region",
        "type": "graph",
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 0,
          "y": 31
        },
        "targets": [
          {
            "expr": "pg_database_size_by_region_size_bytes",
            "legendFormat": "{{region}}",
            "refId": "A"
          }
        ],
        "yAxes": [
          {
            "label": "Size",
            "format": "bytes",
            "logBase": 1,
            "min": 0
          }
        ]
      },
      {
        "id": 14,
        "title": "Table Sizes (Top 10)",
        "description": "Largest tables across all regions",
        "type": "bargauge",
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 12,
          "y": 31
        },
        "targets": [
          {
            "expr": "topk(10, pg_table_sizes_total_bytes)",
            "legendFormat": "{{schemaname}}.{{tablename}}",
            "refId": "A"
          }
        ],
        "options": {
          "orientation": "horizontal",
          "displayMode": "gradient",
          "showUnfilled": true
        },
        "fieldConfig": {
          "defaults": {
            "unit": "bytes",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {
                  "value": null,
                  "color": "green"
                },
                {
                  "value": 1073741824,
                  "color": "yellow"
                },
                {
                  "value": 10737418240,
                  "color": "red"
                }
              ]
            }
          }
        }
      },
      {
        "id": 15,
        "title": "Performance Metrics",
        "type": "row",
        "collapsed": false,
        "gridPos": {
          "h": 1,
          "w": 24,
          "x": 0,
          "y": 39
        }
      },
      {
        "id": 16,
        "title": "Replication Throughput (Bytes Sent)",
        "description": "Data transfer rate to replicas",
        "type": "graph",
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 0,
          "y": 40
        },
        "targets": [
          {
            "expr": "rate(pg_stat_replication_sent_bytes[5m])",
            "legendFormat": "{{application_name}} - sent",
            "refId": "A"
          },
          {
            "expr": "rate(pg_stat_replication_write_bytes[5m])",
            "legendFormat": "{{application_name}} - written",
            "refId": "B"
          }
        ],
        "yAxes": [
          {
            "label": "Throughput",
            "format": "Bps",
            "logBase": 1,
            "min": 0
          }
        ]
      },
      {
        "id": 17,
        "title": "Replication Connection Count",
        "description": "Number of active replication connections over time",
        "type": "graph",
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 12,
          "y": 40
        },
        "targets": [
          {
            "expr": "count(pg_replication_lag_seconds) by (state)",
            "legendFormat": "{{state}}",
            "refId": "A"
          }
        ],
        "yAxes": [
          {
            "label": "Connections",
            "format": "short",
            "logBase": 1,
            "min": 0
          }
        ]
      },
      {
        "id": 18,
        "title": "Sync State Distribution",
        "description": "Distribution of async vs sync replication",
        "type": "piechart",
        "gridPos": {
          "h": 8,
          "w": 8,
          "x": 0,
          "y": 48
        },
        "targets": [
          {
            "expr": "count(pg_replication_lag_seconds) by (sync_state)",
            "legendFormat": "{{sync_state}}",
            "refId": "A"
          }
        ],
        "options": {
          "legend": {
            "displayMode": "table",
            "placement": "right",
            "values": ["value", "percent"]
          }
        }
      },
      {
        "id": 19,
        "title": "Replication State Distribution",
        "description": "Current state of all replication connections",
        "type": "piechart",
        "gridPos": {
          "h": 8,
          "w": 8,
          "x": 8,
          "y": 48
        },
        "targets": [
          {
            "expr": "count(pg_replication_lag_seconds) by (state)",
            "legendFormat": "{{state}}",
            "refId": "A"
          }
        ],
        "options": {
          "legend": {
            "displayMode": "table",
            "placement": "right",
            "values": ["value", "percent"]
          }
        }
      },
      {
        "id": 20,
        "title": "Alerts & SLOs",
        "description": "SLO: 99.9% uptime, <5s lag, <5min failover",
        "type": "stat",
        "gridPos": {
          "h": 8,
          "w": 8,
          "x": 16,
          "y": 48
        },
        "targets": [
          {
            "expr": "(count(pg_replication_lag_seconds < 5) / count(pg_replication_lag_seconds)) * 100",
            "legendFormat": "Lag SLO Compliance %",
            "refId": "A"
          }
        ],
        "options": {
          "colorMode": "background",
          "graphMode": "area",
          "justifyMode": "auto",
          "orientation": "auto",
          "reduceOptions": {
            "values": false,
            "calcs": ["lastNotNull"],
            "fields": ""
          },
          "textMode": "value_and_name"
        },
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {
                  "value": null,
                  "color": "red"
                },
                {
                  "value": 95,
                  "color": "yellow"
                },
                {
                  "value": 99,
                  "color": "green"
                }
              ]
            }
          }
        }
      }
    ],
    "time": {
      "from": "now-6h",
      "to": "now"
    },
    "timepicker": {
      "refresh_intervals": ["10s", "30s", "1m", "5m", "15m", "30m", "1h"]
    },
    "refresh": "30s",
    "schemaVersion": 36,
    "version": 1,
    "annotations": {
      "list": [
        {
          "name": "Failover Events",
          "datasource": "Prometheus",
          "enable": true,
          "expr": "changes(pg_replication_slots_active[5m]) > 0",
          "iconColor": "red",
          "tagKeys": "event,region"
        }
      ]
    },
    "templating": {
      "list": [
        {
          "name": "region",
          "type": "query",
          "datasource": "Prometheus",
          "query": "label_values(pg_database_size_by_region_size_bytes, region)",
          "multi": true,
          "includeAll": true,
          "allValue": ".*"
        },
        {
          "name": "application",
          "type": "query",
          "datasource": "Prometheus",
          "query": "label_values(pg_replication_lag_seconds, application_name)",
          "multi": true,
          "includeAll": true,
          "allValue": ".*"
        }
      ]
    }
  }
}

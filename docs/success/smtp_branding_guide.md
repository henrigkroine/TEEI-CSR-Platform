# SMTP Domain Branding & Deliverability Guide

## Overview

This guide covers the complete setup of custom SMTP domains for tenant-branded email communications from the TEEI CSR Platform. Proper SMTP configuration ensures:

- **Brand Consistency**: Emails sent from your domain (e.g., `noreply@yourcompany.com`)
- **Email Deliverability**: Higher inbox placement rates
- **Trust & Security**: DKIM, SPF, and DMARC authentication
- **Reputation Management**: Monitoring and maintaining sender reputation

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [DNS Record Setup](#dns-record-setup)
3. [Domain Verification](#domain-verification)
4. [Email Template Branding](#email-template-branding)
5. [Deliverability Best Practices](#deliverability-best-practices)
6. [Testing Checklist](#testing-checklist)
7. [Troubleshooting](#troubleshooting)
8. [Reputation Monitoring](#reputation-monitoring)

---

## Prerequisites

### Requirements

- **DNS Access**: Ability to add TXT and CNAME records to your domain
- **Domain Ownership**: Verified ownership of the domain you want to use
- **Email Provider**: SendGrid account (configured by TEEI platform)
- **Admin Access**: TEEI Corporate Cockpit admin permissions

### Recommended Setup

- **Subdomain Usage**: Use a subdomain like `mail.yourcompany.com` for email sending
- **Dedicated Domain**: Consider a dedicated domain for transactional emails (e.g., `notify.yourcompany.com`)
- **Propagation Time**: Allow 24-48 hours for DNS changes to propagate globally

---

## DNS Record Setup

### Step 1: Generate DNS Records in TEEI Platform

1. **Navigate to SMTP Settings**
   - Log in to TEEI Corporate Cockpit
   - Go to **Settings** → **Email & SMTP** → **Domain Configuration**

2. **Add New Domain**
   - Click **"Add SMTP Domain"**
   - Fill in the form:
     - **Domain**: `mail.yourcompany.com` (or your chosen domain)
     - **From Email**: `noreply@mail.yourcompany.com`
     - **From Name**: `Your Company`
     - **DMARC Email**: `dmarc-reports@yourcompany.com` (for receiving DMARC reports)
   - Click **"Generate DNS Records"**

3. **Copy DNS Records**
   - The platform will generate 4 DNS records:
     - **SPF**: Sender Policy Framework
     - **DKIM**: DomainKeys Identified Mail
     - **DMARC**: Domain-based Message Authentication, Reporting & Conformance
     - **Verification**: TEEI domain verification

### Step 2: Add DNS Records to Your Domain

#### SPF Record (TXT)

**Purpose**: Specifies which mail servers can send email on behalf of your domain.

```
Type: TXT
Name: mail.yourcompany.com
Value: v=spf1 include:sendgrid.net include:_spf.google.com ~all
TTL: 3600 (or default)
```

**Breakdown**:
- `v=spf1`: SPF version 1
- `include:sendgrid.net`: Allow SendGrid servers
- `include:_spf.google.com`: Allow Google Workspace (if applicable)
- `~all`: Soft fail for unauthorized servers

**Important Notes**:
- Replace `mail.yourcompany.com` with your actual domain
- If you have existing SPF record, merge them (only one SPF record allowed per domain)
- Use `~all` (soft fail) initially; change to `-all` (hard fail) after testing

#### DKIM Record (TXT)

**Purpose**: Adds a digital signature to verify email authenticity.

```
Type: TXT
Name: teei20251115._domainkey.mail.yourcompany.com
Value: v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...
TTL: 3600
```

**Breakdown**:
- `v=DKIM1`: DKIM version 1
- `k=rsa`: RSA key type
- `p=...`: Public key (generated by TEEI platform)

**Important Notes**:
- The selector (e.g., `teei20251115`) is unique per setup
- Copy the full public key exactly as provided
- Don't add line breaks or spaces in the public key

#### DMARC Record (TXT)

**Purpose**: Specifies how to handle emails that fail SPF/DKIM checks.

```
Type: TXT
Name: _dmarc.mail.yourcompany.com
Value: v=DMARC1; p=quarantine; rua=mailto:dmarc-reports@yourcompany.com; ruf=mailto:dmarc-reports@yourcompany.com; fo=1
TTL: 3600
```

**Breakdown**:
- `v=DMARC1`: DMARC version 1
- `p=quarantine`: Quarantine emails that fail (options: `none`, `quarantine`, `reject`)
- `rua=mailto:...`: Aggregate report email
- `ruf=mailto:...`: Forensic report email
- `fo=1`: Generate forensic reports on any failure

**Policy Progression**:
1. Start with `p=none` (monitoring only)
2. After 1-2 weeks, move to `p=quarantine`
3. After confirming no false positives, move to `p=reject`

#### Verification Record (TXT)

**Purpose**: Verifies domain ownership for TEEI platform.

```
Type: TXT
Name: _teei-verify.mail.yourcompany.com
Value: teei-verify=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
TTL: 3600
```

**Important Notes**:
- This record is unique to your account
- Can be removed after verification is complete
- Required for initial domain setup

### Step 3: Verify DNS Records

After adding DNS records to your domain:

1. **Check DNS Propagation**
   - Wait 10-15 minutes for initial propagation
   - Use online tools:
     - https://dnschecker.org
     - https://mxtoolbox.com/SuperTool.aspx
   - Verify all 4 records are visible globally

2. **Verify in TEEI Platform**
   - Return to **Settings** → **Email & SMTP** → **Domain Configuration**
   - Click **"Verify Domain"** next to your domain
   - Platform will check all DNS records
   - Wait for verification status (may take 1-2 minutes)

3. **Check Verification Results**
   - ✅ **Verified**: All records found and correct
   - ⚠️ **Partial**: Some records missing or incorrect
   - ❌ **Failed**: Verification failed

---

## Domain Verification

### Verification Process

The TEEI platform verifies your domain by checking:

1. **Verification TXT Record**: Confirms domain ownership
2. **SPF Record**: Validates SendGrid inclusion
3. **DKIM Record**: Confirms DKIM public key matches
4. **DMARC Record**: Ensures DMARC policy exists

### Common Verification Issues

#### Issue: Verification TXT Record Not Found

**Solution**:
- Double-check the record name includes `_teei-verify.` prefix
- Ensure no typos in the verification token
- Wait 30+ minutes for DNS propagation
- Use `dig` or `nslookup` to manually check:
  ```bash
  dig TXT _teei-verify.mail.yourcompany.com
  ```

#### Issue: SPF Record Not Found or Invalid

**Solution**:
- Verify only ONE SPF record exists for the domain
- If merging with existing SPF, combine all `include:` statements
- Check for syntax errors (missing `v=spf1` or invalid mechanism)
- Ensure record doesn't exceed 255 characters

#### Issue: DKIM Record Not Found

**Solution**:
- Verify the full selector name (e.g., `teei20251115._domainkey.mail.yourcompany.com`)
- Check for line breaks in the public key value
- Ensure no spaces in the `p=` value
- Some DNS providers require splitting long TXT records

#### Issue: DMARC Record Invalid

**Solution**:
- Verify record is at `_dmarc.mail.yourcompany.com` (not root domain)
- Check syntax (must start with `v=DMARC1;`)
- Ensure email addresses are valid
- Validate using: https://mxtoolbox.com/dmarc.aspx

---

## Email Template Branding

### Customizing From Address

Each tenant can customize their email sender information:

1. **Navigate to Branding Settings**
   - Go to **Settings** → **Branding** → **Email Configuration**

2. **Configure Sender Information**
   - **From Name**: Display name (e.g., "Acme Corp Notifications")
   - **From Email**: Must use verified domain (e.g., `noreply@mail.acmecorp.com`)
   - **Reply-To Email**: (Optional) Different reply address (e.g., `support@acmecorp.com`)
   - **Reply-To Name**: (Optional) Display name for replies

3. **Email Signature**
   - **Company Name**: Appears in email footer
   - **Support Email**: Contact email for recipients
   - **Website URL**: Link to company website
   - **Logo**: Upload for email header (see below)

### Email Template Logo

**Requirements**:
- **Format**: PNG or JPG
- **Size**: 200x60 pixels recommended (max 400x120)
- **File Size**: Max 200 KB
- **Background**: Transparent PNG preferred

**Upload Steps**:
1. Go to **Settings** → **Branding** → **Email Configuration**
2. Click **"Upload Email Logo"**
3. Select file
4. Preview shows how logo appears in emails
5. Click **"Save"**

### Template Customization

Customize email templates for different notification types:

**Available Templates**:
- SLA Breach Alert
- Approval Required
- Report Ready
- Export Complete
- Password Reset
- Welcome Email

**Customization Options**:
- Header color (matches brand primary color)
- Button colors (primary/secondary)
- Font family (limited to web-safe fonts)
- Footer text and links

**Best Practices**:
- Keep branding consistent with your website
- Use high-contrast colors for accessibility
- Test emails on multiple clients (Gmail, Outlook, Apple Mail)
- Include unsubscribe link (required for compliance)

---

## Deliverability Best Practices

### 1. Domain Reputation

**Warm Up Your Domain**:
- Start with low volume (50-100 emails/day)
- Gradually increase over 2-4 weeks
- Monitor bounce and complaint rates
- Don't spike volume suddenly

**Maintain Good Reputation**:
- Keep bounce rate < 2%
- Keep complaint rate < 0.1%
- Remove hard bounces immediately
- Monitor spam reports

### 2. Email List Hygiene

**Clean Your Lists**:
- Remove invalid email addresses
- Use double opt-in for new subscribers
- Remove unengaged recipients (no opens in 6+ months)
- Validate emails before sending

**Segmentation**:
- Send relevant content to targeted groups
- Don't send to entire list unnecessarily
- Respect user preferences and frequency

### 3. Content Best Practices

**Avoid Spam Triggers**:
- ❌ ALL CAPS SUBJECT LINES
- ❌ Excessive exclamation marks!!!
- ❌ "Free", "Guaranteed", "Act Now" in subject
- ❌ Image-only emails (no text)
- ✅ Clear, relevant subject lines
- ✅ Balanced text-to-image ratio
- ✅ Personalized content

**Email Structure**:
- Plain text alternative for HTML emails
- Responsive design for mobile
- Clear call-to-action buttons
- Unsubscribe link in footer

### 4. Sending Patterns

**Consistency**:
- Send at regular, predictable times
- Avoid sending only on specific days (looks like spam)
- Maintain consistent sending volume

**Engagement**:
- Monitor open and click rates
- Re-engage inactive subscribers
- Remove chronic non-openers

### 5. Authentication & Security

**Required**:
- ✅ SPF record configured
- ✅ DKIM signature enabled
- ✅ DMARC policy set

**Recommended**:
- ✅ BIMI record (Brand Indicators for Message Identification)
- ✅ MTA-STS (SMTP TLS Reporting)
- ✅ TLS encryption enabled

---

## Testing Checklist

### Pre-Launch Testing

- [ ] **DNS Records Verified**
  - SPF record exists and includes SendGrid
  - DKIM record exists with correct public key
  - DMARC policy configured
  - Verification record found

- [ ] **Domain Verified in TEEI**
  - Green checkmark next to domain
  - No verification errors
  - From address uses verified domain

- [ ] **Send Test Emails**
  - Send to Gmail account
  - Send to Outlook/Office 365 account
  - Send to corporate email server
  - Check inbox placement (not spam)

- [ ] **Verify Email Authentication**
  - Check email headers for:
    - `DKIM: PASS`
    - `SPF: PASS`
    - `DMARC: PASS`
  - Use https://www.mail-tester.com
  - Use https://mxtoolbox.com/deliverability

- [ ] **Template Rendering**
  - Logo displays correctly
  - Colors match brand
  - Buttons work on all clients
  - Mobile responsive
  - Unsubscribe link works

- [ ] **Links and CTAs**
  - All links clickable
  - Links go to correct destinations
  - Tracking parameters present (if enabled)
  - HTTPS for all links

### Deliverability Testing Tools

**Email Authentication Checkers**:
- https://www.mail-tester.com (score should be 9+/10)
- https://mxtoolbox.com/deliverability
- https://postmarkapp.com/tools/dmarc

**Inbox Placement Testing**:
- https://www.emailonacid.com
- https://www.litmus.com
- Send to seed list (Gmail, Outlook, Yahoo, etc.)

**Header Analysis**:
- View full email headers in Gmail: More → Show original
- Check `Authentication-Results` header
- Verify `DKIM-Signature` present

---

## Troubleshooting

### Issue: Emails Going to Spam

**Possible Causes**:
1. Domain not properly authenticated
2. Poor sender reputation
3. Content triggers spam filters
4. Low engagement rates

**Solutions**:
1. **Check Authentication**:
   - Verify SPF, DKIM, DMARC are passing
   - Use mail-tester.com to identify issues
   - Review email headers

2. **Improve Reputation**:
   - Warm up domain gradually
   - Remove bounced emails
   - Monitor complaint rate
   - Send only to engaged recipients

3. **Optimize Content**:
   - Remove spam trigger words
   - Improve text-to-image ratio
   - Add plain text version
   - Include clear unsubscribe link

4. **Engagement**:
   - Segment your list
   - Send relevant content
   - Remove unengaged subscribers
   - Optimize send time

### Issue: High Bounce Rate

**Hard Bounces** (permanent):
- Invalid email address
- Domain doesn't exist
- Mailbox doesn't exist

**Action**: Remove immediately from list

**Soft Bounces** (temporary):
- Mailbox full
- Server temporarily unavailable
- Message too large

**Action**: Retry 2-3 times, then remove

**Solutions**:
1. Validate emails before adding to list
2. Use double opt-in
3. Monitor bounce reports in TEEI dashboard
4. Clean list regularly

### Issue: DKIM Verification Failing

**Symptoms**:
- Email headers show `DKIM: FAIL`
- Deliverability issues

**Causes**:
- DKIM record not found
- Public key mismatch
- Email modified in transit

**Solutions**:
1. Verify DKIM DNS record exists:
   ```bash
   dig TXT teei20251115._domainkey.mail.yourcompany.com
   ```
2. Compare DNS public key with TEEI platform key
3. Regenerate DKIM keys if needed
4. Check for email forwarding (breaks DKIM)

### Issue: SPF Lookup Limit Exceeded

**Symptoms**:
- Email headers show `SPF: PERMERROR`
- SPF validation fails

**Cause**:
- SPF record has too many DNS lookups (limit: 10)

**Solution**:
1. Count `include:` mechanisms in SPF record
2. Flatten SPF record using IP ranges instead of includes
3. Use SPF flattening tool: https://dmarcian.com/spf-survey/

Example flattened SPF:
```
v=spf1 ip4:167.89.0.0/17 ip4:208.117.48.0/20 ~all
```

---

## Reputation Monitoring

### TEEI Platform Dashboard

The TEEI platform provides real-time reputation monitoring:

1. **Navigate to Email Reputation**
   - Go to **Settings** → **Email & SMTP** → **Reputation**

2. **View Metrics**
   - **Reputation Score**: 0-100 (aim for 90+)
   - **Bounce Rate**: Percentage of bounced emails
   - **Complaint Rate**: Percentage of spam complaints
   - **Status**: Excellent, Good, Fair, Poor, Critical

3. **Review Recommendations**
   - Platform provides actionable recommendations
   - Follow suggested actions to improve score

### Reputation Score Breakdown

| Score | Status | Action Required |
|-------|--------|-----------------|
| 90-100 | Excellent | Maintain current practices |
| 70-89 | Good | Monitor and optimize |
| 50-69 | Fair | Review best practices, clean list |
| 30-49 | Poor | Immediate action required |
| 0-29 | Critical | Stop sending, investigate issues |

### External Reputation Checkers

**Monitor Your Sender IP**:
- https://senderscore.org (Return Path)
- https://talosintelligence.com/reputation_center
- https://www.barracudacentral.org/lookups

**Monitor Your Domain**:
- https://postmaster.google.com (Gmail Postmaster Tools)
- https://postmaster.live.com (Microsoft SNDS)
- https://postmaster.yahoo.com

**Blacklist Checkers**:
- https://mxtoolbox.com/blacklists.aspx
- https://multirbl.valli.org

### Bounce & Complaint Handling

**Automated Handling by TEEI**:
- Hard bounces: Automatically removed from lists
- Soft bounces: Retried up to 3 times
- Complaints: User unsubscribed and suppressed
- Unsubscribes: Honored immediately

**Manual Review**:
- Review bounce reasons in dashboard
- Identify patterns (domain-specific, content-specific)
- Take corrective action

---

## Advanced Configuration

### Subdomain Strategy

**Recommendation**: Use different subdomains for different email types:

- `mail.yourcompany.com`: Transactional emails
- `news.yourcompany.com`: Marketing emails
- `alerts.yourcompany.com`: System alerts

**Benefits**:
- Isolated reputation per email type
- Easier to troubleshoot issues
- Better organization

### Multiple From Addresses

Configure different from addresses for different notification types:

- `noreply@mail.yourcompany.com`: System notifications
- `approvals@mail.yourcompany.com`: Approval workflows
- `reports@mail.yourcompany.com`: Report delivery

**Setup**:
1. Verify each subdomain separately
2. Configure per-notification-type in TEEI
3. Monitor reputation for each

### Custom DKIM Selectors

For advanced users, rotate DKIM keys periodically:

1. Generate new DKIM key pair in TEEI
2. Add new DNS record with new selector
3. Test with new selector
4. Update platform to use new selector
5. Remove old DNS record after 48 hours

---

## Compliance & Legal

### CAN-SPAM Act (US)

**Required**:
- ✅ Unsubscribe link in every email
- ✅ Physical mailing address in footer
- ✅ Accurate "From" and "Subject" lines
- ✅ Honor unsubscribe requests within 10 days

### GDPR (EU)

**Required**:
- ✅ Explicit consent before sending emails
- ✅ Easy opt-out mechanism
- ✅ Right to be forgotten (delete data)
- ✅ Data processing agreement

### CASL (Canada)

**Required**:
- ✅ Express or implied consent
- ✅ Sender identification
- ✅ Unsubscribe mechanism

---

## Appendix

### DNS Record Templates

**For GoDaddy**:
```
Type: TXT
Host: mail.yourcompany.com
TXT Value: v=spf1 include:sendgrid.net ~all
TTL: 1 Hour
```

**For Cloudflare**:
```
Type: TXT
Name: mail.yourcompany.com
Content: v=spf1 include:sendgrid.net ~all
TTL: Auto
Proxy status: DNS only (gray cloud)
```

**For AWS Route53**:
```
Name: mail.yourcompany.com
Type: TXT
Value: "v=spf1 include:sendgrid.net ~all"
TTL: 3600
Routing Policy: Simple
```

### Useful Commands

**Check SPF Record**:
```bash
dig TXT mail.yourcompany.com +short
```

**Check DKIM Record**:
```bash
dig TXT teei20251115._domainkey.mail.yourcompany.com +short
```

**Check DMARC Record**:
```bash
dig TXT _dmarc.mail.yourcompany.com +short
```

**Test Email Authentication**:
```bash
# Send test email to: check-auth@verifier.port25.com
# You'll receive a reply with authentication results
```

### Support Resources

- **TEEI Documentation**: https://docs.teei-platform.com/smtp
- **SendGrid Docs**: https://docs.sendgrid.com/ui/account-and-settings/how-to-set-up-domain-authentication
- **DMARC Guide**: https://dmarc.org/overview/
- **SPF Validator**: http://www.kitterman.com/spf/validate.html

---

**Last Updated**: 2025-11-15
**Version**: 1.0
**Maintained by**: TEEI Platform Team

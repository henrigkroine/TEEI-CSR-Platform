---
import { detectLanguage, t } from '../lib/i18n';
import BaseLayout from '../layouts/BaseLayout.astro';

const lang = detectLanguage(Astro.request);
const pageTitle = `Reset Password - ${t(lang, 'app.title')}`;
---

<BaseLayout title={pageTitle} lang={lang}>
  <div class="auth-page page-enter">
    <div class="auth-shell">
      <section class="auth-brand" aria-label="Welcome">
        <a class="auth-back" href="/en">← Back to TEEI.io</a>
        <div class="auth-brand-inner">
          <div class="auth-mark" aria-hidden="true">
            <span class="auth-mark-dot"></span>
          </div>
          <h1 class="auth-title">
            <span class="text-gradient-accent">TEEI</span> Corporate Cockpit
          </h1>
          <p class="auth-subtitle">{t(lang, 'app.subtitle')}</p>

          <ul class="auth-points" aria-label="Highlights">
            <li><span class="auth-bullet"></span> Secure password recovery</li>
            <li><span class="auth-bullet"></span> Email verification</li>
            <li><span class="auth-bullet"></span> Multi-tenant access controls</li>
          </ul>
        </div>
      </section>

      <section class="auth-card card" aria-label="Reset Password">
        <header class="auth-card-header">
          <div>
            <p class="auth-card-label">Password Recovery</p>
            <h2 class="auth-card-title">Reset your password</h2>
            <p class="auth-card-subtitle">Enter your email address and we'll send you a link to reset your password.</p>
          </div>
        </header>

        <div id="forgot-password-error" class="auth-error" role="alert" aria-live="polite" hidden></div>
        <div id="forgot-password-success" class="auth-success" role="alert" aria-live="polite" hidden></div>

        <form id="forgot-password-form" class="auth-form" novalidate>
          <label class="auth-field">
            <span class="auth-label">Email</span>
            <input
              id="email"
              name="email"
              type="email"
              autocomplete="email"
              class="input"
              placeholder="you@company.com"
              required
            />
          </label>

          <button id="forgot-password-submit" class="btn btn-primary btn-lg press-effect" type="submit">
            <span class="auth-btn-label">Send reset link</span>
            <span id="forgot-password-spinner" class="auth-spinner" aria-hidden="true" hidden></span>
          </button>
        </form>

        <footer class="auth-footnote">
          <div style="text-align: center; margin-top: 16px;">
            <a href="/login" class="auth-link">← Back to sign in</a>
          </div>
          <div style="text-align: center; margin-top: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap;">
            <span class="badge badge-outline">Demo</span>
            <span style="font-size: 12px; color: var(--color-text-tertiary);">
              In production, password reset is handled via API Gateway with email verification.
            </span>
          </div>
        </footer>
      </section>
    </div>
  </div>

  <script is:inline>
    (function () {
      const form = document.getElementById('forgot-password-form');
      const errorEl = document.getElementById('forgot-password-error');
      const successEl = document.getElementById('forgot-password-success');
      const submitBtn = document.getElementById('forgot-password-submit');
      const spinner = document.getElementById('forgot-password-spinner');

      function setError(message) {
        if (!errorEl) return;
        if (successEl) successEl.hidden = true;
        if (!message) {
          errorEl.hidden = true;
          errorEl.textContent = '';
          return;
        }
        errorEl.textContent = message;
        errorEl.hidden = false;
      }

      function setSuccess(message) {
        if (!successEl) return;
        if (errorEl) errorEl.hidden = true;
        if (!message) {
          successEl.hidden = true;
          successEl.textContent = '';
          return;
        }
        successEl.textContent = message;
        successEl.hidden = false;
      }

      function setLoading(isLoading) {
        if (submitBtn) submitBtn.toggleAttribute('disabled', isLoading);
        if (spinner) spinner.hidden = !isLoading;
      }

      if (!form) return;
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setError('');
        setSuccess('');

        const fd = new FormData(form);
        const email = String(fd.get('email') || '').trim();

        if (!email) {
          setError('Please enter your email address.');
          return;
        }

        setLoading(true);
        try {
          const res = await fetch('/api/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email }),
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            setError(data?.message || data?.error || 'Unable to send reset link. Please try again.');
            setLoading(false);
            return;
          }

          setSuccess('If an account exists with that email, we\'ve sent you a password reset link.');
          form.reset();
          setLoading(false);
        } catch (err) {
          setError('Network error. Please try again.');
          setLoading(false);
        }
      });
    })();
  </script>

  <style>
    .auth-page {
      min-height: 100vh;
      padding: 40px 20px;
      background: radial-gradient(1200px 600px at 20% 20%, rgba(186, 143, 90, 0.25), transparent 55%),
        linear-gradient(135deg, #00393f 0%, #01272a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .auth-shell {
      width: 100%;
      max-width: 1040px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
      align-items: stretch;
    }

    @media (min-width: 960px) {
      .auth-shell {
        grid-template-columns: 1.05fr 0.95fr;
        gap: 24px;
      }
    }

    .auth-brand {
      color: rgba(255, 255, 255, 0.92);
      border-radius: 20px;
      padding: 28px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .auth-back {
      display: inline-block;
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 18px;
    }
    .auth-back:hover { color: #BA8F5A; }

    .auth-brand-inner { max-width: 460px; }

    .auth-mark {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: rgba(186, 143, 90, 0.18);
      border: 1px solid rgba(186, 143, 90, 0.35);
      display: grid;
      place-items: center;
      margin-bottom: 14px;
    }
    .auth-mark-dot {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #BA8F5A;
      box-shadow: 0 0 0 6px rgba(186, 143, 90, 0.18);
    }

    .auth-title {
      color: white;
      font-size: 34px;
      line-height: 1.1;
      margin: 0;
    }

    .auth-subtitle {
      margin-top: 10px;
      color: rgba(255, 255, 255, 0.78);
      font-size: 15px;
      line-height: 1.6;
    }

    .auth-points {
      list-style: none;
      padding: 0;
      margin: 18px 0 0;
      display: grid;
      gap: 10px;
      color: rgba(255, 255, 255, 0.82);
      font-size: 14px;
    }

    .auth-bullet {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(186, 143, 90, 0.9);
      margin-right: 10px;
      transform: translateY(-1px);
      box-shadow: 0 0 0 4px rgba(186, 143, 90, 0.15);
    }

    .auth-card {
      padding: 24px;
      border-radius: 20px;
    }

    .auth-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .auth-card-title {
      margin: 6px 0 0;
      font-size: 26px;
    }

    .auth-card-label {
      font-size: var(--text-xs);
      font-weight: var(--font-weight-semibold);
      letter-spacing: var(--tracking-caps);
      color: var(--color-text-tertiary);
      margin: 0;
      text-transform: none;
    }

    .auth-card-subtitle {
      margin: 8px 0 0;
      color: var(--color-text-secondary);
      font-size: 14px;
      line-height: 1.5;
    }

    .auth-form {
      display: grid;
      gap: 14px;
    }

    .auth-field { display: grid; gap: 8px; }
    .auth-label { font-size: 12px; letter-spacing: var(--tracking-caps); text-transform: uppercase; color: var(--color-text-tertiary); font-weight: var(--font-weight-semibold); }

    .auth-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-top: 2px;
    }

    .auth-link {
      font-size: 14px;
      color: var(--color-primary-light);
      text-decoration: none;
      font-weight: 600;
    }
    .auth-link:hover { text-decoration: underline; }

    .auth-error {
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid rgba(220, 38, 38, 0.25);
      background: rgba(220, 38, 38, 0.08);
      color: #991b1b;
      font-size: 14px;
      line-height: 1.4;
      margin-bottom: 12px;
    }
    [data-theme="dark"] .auth-error,
    html.dark .auth-error {
      color: #fecaca;
      border-color: rgba(248, 113, 113, 0.35);
      background: rgba(248, 113, 113, 0.12);
    }

    .auth-success {
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid rgba(5, 150, 105, 0.25);
      background: rgba(5, 150, 105, 0.08);
      color: #065f46;
      font-size: 14px;
      line-height: 1.4;
      margin-bottom: 12px;
    }
    [data-theme="dark"] .auth-success,
    html.dark .auth-success {
      color: #6ee7b7;
      border-color: rgba(16, 185, 129, 0.35);
      background: rgba(16, 185, 129, 0.12);
    }

    .auth-spinner {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.35);
      border-top-color: white;
      animation: authSpin 0.8s linear infinite;
      margin-left: 10px;
    }
    @keyframes authSpin { to { transform: rotate(360deg); } }

    .auth-footnote {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 16px;
      padding-top: 14px;
      border-top: 1px solid var(--color-border-subtle);
      color: var(--color-text-tertiary);
      font-size: 12px;
    }
  </style>
</BaseLayout>

---
import Layout from '../layouts/Layout.astro';
import KPICard from '../components/KPICard';
import Chart from '../components/Chart';
import ErrorMessage from '../components/ErrorMessage';
import { detectLanguage, t } from '../lib/i18n';
import { createApiClient } from '../lib/api';

const lang = detectLanguage(Astro.request);

// Get company ID from cookies or default
const companyId = Astro.cookies.get('companyId')?.value || 'demo-company';

// Get auth token from cookies
const token = Astro.cookies.get('auth_token')?.value;

// Fetch SROI data from analytics service
const apiClient = createApiClient(token);

let sroiData: any = null;
let historicalData: any[] = [];
let error: string | null = null;

try {
  // Fetch SROI metrics
  sroiData = await apiClient.get(`/metrics/sroi/${companyId}`);

  // Fetch historical SROI for trend
  try {
    historicalData = await apiClient.get(`/metrics/sroi/${companyId}/historical`);
    if (!Array.isArray(historicalData)) {
      historicalData = [];
    }
  } catch (e) {
    console.warn('Failed to fetch historical SROI:', e);
  }
} catch (e: any) {
  error = e.message || 'Failed to load SROI data';
  console.error('SROI error:', e);
}

// Prepare chart data
const valueBreakdownData = sroiData ? {
  labels: [
    t(lang, 'sroi.participants'),
    t(lang, 'sroi.volunteers'),
    t(lang, 'sroi.community'),
  ],
  datasets: [
    {
      data: [
        sroiData.participantValue || 0,
        sroiData.volunteerValue || 0,
        sroiData.communityValue || 0,
      ],
      backgroundColor: [
        'rgba(59, 130, 246, 0.8)',
        'rgba(34, 197, 94, 0.8)',
        'rgba(168, 85, 247, 0.8)',
      ],
    },
  ],
} : null;

const historicalRoiData = historicalData.length > 0 ? {
  labels: historicalData.map((d) => {
    const date = new Date(d.period || d.timestamp);
    return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
  }),
  datasets: [
    {
      label: t(lang, 'sroi.roiRatio'),
      data: historicalData.map((d) => d.ratio || 0),
      borderColor: 'rgb(34, 197, 94)',
      backgroundColor: 'rgba(34, 197, 94, 0.1)',
      tension: 0.4,
      fill: true,
    },
  ],
} : null;
---

<Layout title={t(lang, 'sroi.title')}>
  <div class="space-y-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
          {t(lang, 'sroi.title')}
        </h1>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
          {t(lang, 'sroi.subtitle')}
        </p>
      </div>
      <button
        id="exportPdfBtn"
        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700"
      >
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        {t(lang, 'sroi.generateReport')}
      </button>
    </div>

    {error && (
      <ErrorMessage client:load message={error} />
    )}

    {!error && sroiData && (
      <>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <KPICard
            client:load
            title={t(lang, 'sroi.totalInvestment')}
            value={`$${((sroiData.totalInvestment || 0) / 1000).toFixed(0)}K`}
            subtitle={t(lang, 'sroi.programCosts')}
          />
          <KPICard
            client:load
            title={t(lang, 'sroi.socialValue')}
            value={`$${((sroiData.socialValue || 0) / 1000000).toFixed(2)}M`}
            subtitle={t(lang, 'sroi.created')}
            trend={sroiData.trend}
          />
          <KPICard
            client:load
            title={t(lang, 'sroi.roiRatio')}
            value={`${(sroiData.ratio || 0).toFixed(2)}:1`}
            subtitle={t(lang, 'sroi.returnRatio')}
            trend={sroiData.ratioTrend}
          />
        </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
          {t(lang, 'sroi.breakdown')}
        </h2>
        <Chart client:load type="doughnut" data={valueBreakdownData} height={300} />
        <div class="mt-6 space-y-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
              <div class="w-3 h-3 rounded-full bg-blue-500"></div>
              <span class="text-sm text-gray-700 dark:text-gray-300">{t(lang, 'sroi.participants')}</span>
            </div>
            <span class="text-sm font-semibold text-gray-900 dark:text-white">$850K</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
              <div class="w-3 h-3 rounded-full bg-green-500"></div>
              <span class="text-sm text-gray-700 dark:text-gray-300">{t(lang, 'sroi.volunteers')}</span>
            </div>
            <span class="text-sm font-semibold text-gray-900 dark:text-white">$625K</span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-2">
              <div class="w-3 h-3 rounded-full bg-purple-500"></div>
              <span class="text-sm text-gray-700 dark:text-gray-300">{t(lang, 'sroi.community')}</span>
            </div>
            <span class="text-sm font-semibold text-gray-900 dark:text-white">$400K</span>
          </div>
        </div>
      </div>

      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
          Historical ROI Trend
        </h2>
        <Chart client:load type="line" data={historicalRoiData} height={300} />
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
        Value Calculation Details
      </h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                Category
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                Metric
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                Value per Unit
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                Total Units
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                Total Value
              </th>
            </tr>
          </thead>
          <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                Participant Outcomes
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                Job placements
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                $25,000
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                34
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 dark:text-white">
                $850,000
              </td>
            </tr>
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                Volunteer Benefits
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                Skill development hours
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                $50
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                12,500
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 dark:text-white">
                $625,000
              </td>
            </tr>
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                Community Impact
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                Integration success
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                $10,000
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                40
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 dark:text-white">
                $400,000
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
      </>
    )}
</Layout>

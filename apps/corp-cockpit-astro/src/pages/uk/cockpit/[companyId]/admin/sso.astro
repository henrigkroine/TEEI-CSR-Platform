---
import BaseLayout from '../../../../../layouts/BaseLayout.astro';
import { hasPermission } from '../../../../../utils/rbac';
import SSOSettings from '../../../../../components/identity/SSOSettings.tsx';
import RoleMappingTable from '../../../../../components/identity/RoleMappingTable.tsx';
import SCIMRoleMappingEditor from '../../../../../components/identity/SCIMRoleMappingEditor.tsx';
import SCIMStatus from '../../../../../components/identity/SCIMStatus.tsx';
import SyncTestButton from '../../../../../components/identity/SyncTestButton.tsx';

// Extract route parameters
const { companyId } = Astro.params;
const lang = 'uk';
const user = Astro.locals.user;
const tenantContext = Astro.locals.tenantContext;

// Middleware handles auth/tenant validation
if (!user || !tenantContext) {
  return Astro.redirect('/login');
}

// Verify tenant context matches route
if (tenantContext.companyId !== companyId) {
  return Astro.redirect(`/${lang}/cockpit/401`);
}

// Only ADMIN and SUPER_ADMIN can view SSO settings
const canViewSSO = hasPermission(user.role, 'ADMIN_CONSOLE');
if (!canViewSSO) {
  return Astro.redirect(`/${lang}/cockpit/${companyId}/401`);
}
---

<BaseLayout title="Налаштування SSO та ідентифікації - TEEI Corporate Cockpit" lang={lang}>
  <div class="sso-settings-page">
    <div class="page-header">
      <div>
        <a href={`/${lang}/cockpit/${companyId}/admin`} class="back-link">
          ← Назад до консолі адміністратора
        </a>
        <h1>Управління SSO та ідентифікацією</h1>
        <p class="subtitle">Налаштування єдиного входу, SCIM-провізіонінгу та відображення ролей</p>
      </div>
    </div>

    <div class="alert-info">
      <strong>Конфігурація лише для читання</strong>
      <p>
        Налаштування SSO та SCIM керуються вашим ІТ-адміністратором через API платформи.
        Ця сторінка відображає поточну конфігурацію для довідки. Щоб внести зміни,
        зверніться до системного адміністратора або використовуйте API конфігурації платформи.
      </p>
    </div>

    {/* SSO Configuration */}
    <section class="settings-section">
      <h2>Налаштування єдиного входу (SSO)</h2>
      <p class="section-description">
        Перегляньте деталі конфігурації SAML та OIDC. Ці налаштування дозволяють користувачам
        автентифікуватися через постачальника ідентифікації вашої організації.
      </p>
      <SSOSettings companyId={companyId} client:load />
    </section>

    {/* Role Mapping */}
    <section class="settings-section">
      <h2>Відображення ролей</h2>
      <p class="section-description">
        Атрибути постачальника ідентифікації (IdP) автоматично відображаються на ролі TEEI.
        Користувачі отримують дозволи на основі їх членства в групах IdP або атрибутів.
      </p>
      {hasPermission(user.role, 'SUPER_ADMIN') ? (
        <SCIMRoleMappingEditor companyId={companyId} client:load />
      ) : (
        <RoleMappingTable companyId={companyId} client:load />
      )}
    </section>

    {/* SCIM Provisioning */}
    <section class="settings-section">
      <div class="section-header">
        <div>
          <h2>SCIM-провізіонінг</h2>
          <p class="section-description">
            SCIM (система керування ідентифікацією між доменами) автоматизує синхронізацію
            користувачів та груп від вашого постачальника ідентифікації. Перегляньте статус
            останньої синхронізації та будь-які помилки.
          </p>
        </div>
        <div class="section-actions">
          <SyncTestButton companyId={companyId} client:load />
        </div>
      </div>
      <SCIMStatus companyId={companyId} client:load />
    </section>

    {/* Help Section */}
    <section class="help-section">
      <h3>Посібник з налаштування</h3>

      <div class="help-grid">
        <div class="help-card">
          <h4>Конфігурація SAML</h4>
          <ul>
            <li><strong>Entity ID:</strong> Унікальний ідентифікатор вашої організації</li>
            <li><strong>ACS URL:</strong> Кінцева точка служби споживача тверджень</li>
            <li><strong>Metadata URL:</strong> Метадані SAML для конфігурації IdP</li>
            <li><strong>Certificate:</strong> Сертифікат X.509 для перевірки підпису</li>
          </ul>
        </div>

        <div class="help-card">
          <h4>Конфігурація OIDC</h4>
          <ul>
            <li><strong>Issuer:</strong> Сервер авторизації OAuth 2.0</li>
            <li><strong>Client ID:</strong> Ідентифікатор додатку</li>
            <li><strong>Redirect URI:</strong> Кінцева точка зворотного виклику після автентифікації</li>
            <li><strong>Scopes:</strong> Запитувана інформація про користувача (openid, profile, email)</li>
          </ul>
        </div>

        <div class="help-card">
          <h4>Відображення ролей</h4>
          <ul>
            <li><strong>IdP Claim:</strong> Атрибут від постачальника ідентифікації (напр., "groups")</li>
            <li><strong>Claim Value:</strong> Конкретне значення для відповідності (напр., "teei-admins")</li>
            <li><strong>TEEI Role:</strong> Призначена роль (VIEWER, MANAGER, ADMIN, SUPER_ADMIN)</li>
            <li><strong>Priority:</strong> Відображення з вищим пріоритетом мають перевагу</li>
          </ul>
        </div>

        <div class="help-card">
          <h4>SCIM-провізіонінг</h4>
          <ul>
            <li><strong>SCIM Endpoint:</strong> Кінцева точка API для синхронізації користувачів/груп</li>
            <li><strong>Bearer Token:</strong> Автентифікація для SCIM-запитів</li>
            <li><strong>Sync Frequency:</strong> Як часто синхронізуються користувачі/групи</li>
            <li><strong>Supported Ops:</strong> Операції створення, оновлення, видалення</li>
          </ul>
        </div>
      </div>

      <div class="api-reference">
        <h4>Кінцеві точки API конфігурації</h4>
        <p>Для зміни налаштувань SSO/SCIM використовуйте наступні кінцеві точки API платформи:</p>
        <ul>
          <li><code>PUT /api/platform/companies/{companyId}/sso/saml</code> - Оновити конфігурацію SAML</li>
          <li><code>PUT /api/platform/companies/{companyId}/sso/oidc</code> - Оновити конфігурацію OIDC</li>
          <li><code>POST /api/platform/companies/{companyId}/role-mappings</code> - Додати відображення ролей</li>
          <li><code>PUT /api/platform/companies/{companyId}/scim</code> - Оновити конфігурацію SCIM</li>
        </ul>
        <p class="api-note">
          <strong>Примітка:</strong> Ці кінцеві точки вимагають ролі <code>SUPER_ADMIN</code> і
          зазвичай керуються лише адміністраторами платформи.
        </p>
      </div>
    </section>
  </div>
</BaseLayout>

<style>
  .sso-settings-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: calc(var(--spacing-unit) * 4);
  }

  .page-header {
    margin-bottom: calc(var(--spacing-unit) * 4);
  }

  .back-link {
    color: var(--color-primary);
    text-decoration: none;
    font-size: 0.9375rem;
    margin-bottom: calc(var(--spacing-unit) * 2);
    display: inline-block;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  h1 {
    font-size: 2rem;
    margin: calc(var(--spacing-unit) * 2) 0 calc(var(--spacing-unit) * 1);
  }

  .subtitle {
    color: var(--color-text-secondary);
    font-size: 1.125rem;
    margin: 0;
  }

  .alert-info {
    background: #dbeafe;
    border: 1px solid #3b82f6;
    border-left: 4px solid #3b82f6;
    padding: calc(var(--spacing-unit) * 3);
    border-radius: var(--border-radius);
    margin-bottom: calc(var(--spacing-unit) * 4);
  }

  .alert-info strong {
    display: block;
    margin-bottom: calc(var(--spacing-unit) * 1);
    color: #1e40af;
  }

  .alert-info p {
    margin: 0;
    color: #1e3a8a;
  }

  .settings-section {
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    padding: calc(var(--spacing-unit) * 4);
    margin-bottom: calc(var(--spacing-unit) * 4);
  }

  .settings-section h2 {
    margin-top: 0;
    margin-bottom: calc(var(--spacing-unit) * 2);
  }

  .section-description {
    color: var(--color-text-secondary);
    margin-bottom: calc(var(--spacing-unit) * 3);
    line-height: 1.6;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: calc(var(--spacing-unit) * 3);
    margin-bottom: calc(var(--spacing-unit) * 3);
  }

  .section-header .section-description {
    margin-bottom: 0;
  }

  .section-actions {
    flex-shrink: 0;
  }

  .help-section {
    background: var(--color-bg-secondary);
    padding: calc(var(--spacing-unit) * 4);
    border-radius: var(--border-radius);
    margin-top: calc(var(--spacing-unit) * 6);
  }

  .help-section h3 {
    margin-top: 0;
    margin-bottom: calc(var(--spacing-unit) * 3);
  }

  .help-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: calc(var(--spacing-unit) * 3);
    margin-bottom: calc(var(--spacing-unit) * 4);
  }

  .help-card {
    background: white;
    padding: calc(var(--spacing-unit) * 3);
    border-radius: var(--border-radius);
    border: 1px solid var(--color-border);
  }

  .help-card h4 {
    margin-top: 0;
    margin-bottom: calc(var(--spacing-unit) * 2);
    color: var(--color-primary);
  }

  .help-card ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .help-card li {
    padding: calc(var(--spacing-unit) * 1) 0;
    border-bottom: 1px solid var(--color-bg-secondary);
  }

  .help-card li:last-child {
    border-bottom: none;
  }

  .help-card strong {
    color: var(--color-text);
    font-weight: 600;
  }

  .api-reference {
    background: white;
    padding: calc(var(--spacing-unit) * 3);
    border-radius: var(--border-radius);
    border: 1px solid var(--color-border);
  }

  .api-reference h4 {
    margin-top: 0;
    margin-bottom: calc(var(--spacing-unit) * 2);
  }

  .api-reference ul {
    list-style: none;
    padding: 0;
    margin: calc(var(--spacing-unit) * 2) 0;
  }

  .api-reference li {
    padding: calc(var(--spacing-unit) * 1.5);
    background: var(--color-bg-secondary);
    margin-bottom: calc(var(--spacing-unit) * 1);
    border-radius: calc(var(--border-radius) / 2);
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
  }

  .api-reference code {
    background: none;
    padding: 0;
    color: var(--color-primary);
    font-weight: 600;
  }

  .api-note {
    background: #fef3c7;
    border: 1px solid #fcd34d;
    padding: calc(var(--spacing-unit) * 2);
    border-radius: calc(var(--border-radius) / 2);
    margin-top: calc(var(--spacing-unit) * 2);
  }

  .api-note strong {
    color: #92400e;
  }

  @media (max-width: 768px) {
    .help-grid {
      grid-template-columns: 1fr;
    }

    .section-header {
      flex-direction: column;
    }
  }
</style>

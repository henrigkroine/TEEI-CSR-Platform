---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { hasPermission } from '../../../../utils/rbac';
import EvidenceList from '../../../../components/evidence/EvidenceList';
import PageHeader from '../../../../components/ui/PageHeader';

// Extract route parameters
const { lang, companyId } = Astro.params;
const user = Astro.locals.user;
const tenantContext = Astro.locals.tenantContext;

// Middleware handles auth/tenant validation, but double-check
if (!user || !tenantContext) {
  return Astro.redirect('/login');
}

// Verify the tenant context matches the route
if (tenantContext.companyId !== companyId || tenantContext.lang !== lang) {
  return Astro.redirect(`/${lang}/cockpit/401`);
}

// Check permissions
const canViewEvidence = hasPermission(user.role, 'VIEW_EVIDENCE');
if (!canViewEvidence) {
  return Astro.redirect(`/${lang}/cockpit/${companyId}?error=permission_denied`);
}
---

<BaseLayout title="Evidence Explorer - TEEI Corporate Cockpit" lang={lang}>
  <div class="evidence-page">
    <PageHeader
      title="Evidence Explorer"
      subtitle="Explore and trace the data sources behind your impact metrics. View evidence lineage, verification status, and confidence scores."
      breadcrumbs={[
        { label: 'Dashboard', href: `/${lang}/cockpit/${companyId}` },
        { label: 'Evidence Explorer' },
      ]}
      client:load
    />

    <div class="evidence-container">
      <EvidenceList companyId={companyId} role={user.role} client:load />
    </div>
  </div>
</BaseLayout>

<style>
  .evidence-page {
    max-width: 1400px;
    margin: 0 auto;
    padding: var(--space-24);
  }

  .evidence-container {
    background-color: var(--color-surface);
    border-radius: var(--card-radius);
    box-shadow: var(--shadow-card);
    border: 1px solid var(--color-border);
    padding: var(--space-24);
    animation: pageEnter 0.3s var(--ease-out) backwards;
    animation-delay: 50ms;
  }

  @keyframes pageEnter {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 768px) {
    .evidence-page {
      padding: var(--space-16);
    }

    .evidence-container {
      padding: var(--space-16);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .evidence-container {
      animation: none;
    }
  }
</style>

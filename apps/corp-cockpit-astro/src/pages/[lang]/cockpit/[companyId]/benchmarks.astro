---
/**
 * Benchmarking & Peer Comparison Dashboard
 *
 * Privacy-preserving cohort benchmarking with k-anonymity and differential privacy.
 * Includes opt-in consent management (admin-only) and advanced cohort builder.
 *
 * @author percentile-viz-engineer & opt-in-governance
 */

import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { hasPermission } from '../../../../utils/rbac';
import CohortBuilder from '../../../../components/benchmarks/CohortBuilder';
import PercentileRibbon from '../../../../components/benchmarks/PercentileRibbon';
import OptInConsent from '../../../../components/benchmarks/OptInConsent';

// Extract route parameters
const { lang, companyId } = Astro.params;
const user = Astro.locals.user;
const tenantContext = Astro.locals.tenantContext;

// Middleware handles auth/tenant validation
if (!user || !tenantContext) {
  return Astro.redirect('/login');
}

// Verify tenant context matches route
if (tenantContext.companyId !== companyId || tenantContext.lang !== lang) {
  return Astro.redirect(`/${lang}/cockpit/401`);
}

// RBAC: VIEWER and above can access benchmarks
const canViewBenchmarks = hasPermission(user.role, 'VIEW_REPORTS');
if (!canViewBenchmarks) {
  return Astro.redirect(`/${lang}/cockpit/${companyId}/401`);
}

// Admin-only access for consent management
const isAdmin = hasPermission(user.role, 'ADMIN_CONSOLE');
---

<BaseLayout title="Benchmarks & Peer Comparison - TEEI Corporate Cockpit" lang={lang}>
  <div class="benchmarks-page">
    {/* Page Header */}
    <div class="page-header">
      <div>
        <a href={`/${lang}/cockpit/${companyId}`} class="back-link">
          ‚Üê Back to Dashboard
        </a>
        <h1>Benchmarking & Peer Comparison</h1>
        <p class="subtitle">
          Compare your CSR performance against peer companies with privacy-preserving analytics
        </p>
      </div>
    </div>

    {/* Privacy Notice */}
    <div class="alert-info" role="alert">
      <div class="alert-icon" aria-hidden="true">üîí</div>
      <div>
        <strong>Privacy & Aggregation</strong>
        <p>
          All benchmark data is fully anonymized and aggregated using k-anonymity (minimum 5 companies)
          and differential privacy (Œµ=0.1). Individual company data is never disclosed.
        </p>
      </div>
    </div>

    {/* Admin-Only: Opt-In Consent Manager */}
    {isAdmin && (
      <div id="consent-section" data-company-id={companyId}>
        {/* This will be hydrated client-side */}
      </div>
    )}

    {/* Cohort Builder */}
    <div id="cohort-builder-section" data-company-id={companyId}>
      {/* This will be hydrated client-side */}
    </div>

    {/* Loading State */}
    <div id="loading-state" class="loading-container">
      <div class="spinner" aria-hidden="true"></div>
      <p role="status">Loading benchmark data...</p>
    </div>

    {/* Benchmarks Results Container */}
    <div id="benchmarks-container" style="display: none;">
      {/* Populated by client-side script */}
    </div>

    {/* Empty State */}
    <div id="empty-state" class="empty-state" style="display: none;">
      <div class="empty-icon" aria-hidden="true">üìä</div>
      <h3>No Benchmark Data Available</h3>
      <p>
        Select cohort criteria above to view benchmark comparisons.
        Make sure your cohort has at least 5 companies to meet privacy requirements.
      </p>
    </div>

    {/* Privacy Notice Footer */}
    <section class="privacy-notice-footer">
      <h2>Privacy Compliance & Methodology</h2>
      <div class="privacy-footer-grid">
        <div class="privacy-footer-card">
          <div class="card-icon" aria-hidden="true">üîê</div>
          <h3>k-Anonymity Protection</h3>
          <p>
            Cohorts must contain at least 5 companies to prevent re-identification.
            Smaller cohorts are automatically blocked to protect privacy.
          </p>
        </div>

        <div class="privacy-footer-card">
          <div class="card-icon" aria-hidden="true">üé≤</div>
          <h3>Differential Privacy</h3>
          <p>
            Mathematical noise (Œµ=0.1) is added to all aggregated values to protect
            individual contributions while maintaining statistical accuracy.
          </p>
        </div>

        <div class="privacy-footer-card">
          <div class="card-icon" aria-hidden="true">üìä</div>
          <h3>Percentile Methodology</h3>
          <p>
            Percentile ranks show your position relative to peers: p50 is median,
            p90 is top 10%, p10 is bottom 10%. Higher is better for all metrics.
          </p>
        </div>

        <div class="privacy-footer-card">
          <div class="card-icon" aria-hidden="true">üîÑ</div>
          <h3>Data Freshness</h3>
          <p>
            Benchmark data is refreshed daily at 2:00 AM UTC. Cohort statistics are
            recalculated nightly to reflect the latest submissions.
          </p>
        </div>
      </div>
    </section>
  </div>

  <script>
    import type { CohortDefinition } from '../../../../components/benchmarks/CohortBuilder';

    // Get parameters from DOM
    const pathParts = window.location.pathname.split('/');
    const companyId = pathParts[pathParts.indexOf('cockpit') + 1];
    const isAdmin = document.getElementById('consent-section') !== null;

    // State
    let currentCohort: CohortDefinition | null = null;
    let consentData: { consent: boolean; consentDate?: Date } | null = null;

    // Initialize
    async function init() {
      // Hydrate consent manager (admin only)
      if (isAdmin) {
        await hydrateConsentManager();
      }

      // Hydrate cohort builder
      await hydrateCohortBuilder();
    }

    // Hydrate OptInConsent component (admin-only)
    async function hydrateConsentManager() {
      try {
        const response = await fetch(`http://localhost:3001/companies/${companyId}/consent`);
        if (response.ok) {
          consentData = await response.json();
        } else {
          consentData = { consent: false };
        }

        const { default: OptInConsent } = await import('../../../../components/benchmarks/OptInConsent');
        const { createRoot } = await import('react-dom/client');
        const { createElement } = await import('react');

        const container = document.getElementById('consent-section');
        if (container) {
          const root = createRoot(container);
          root.render(
            createElement(OptInConsent, {
              companyId,
              currentConsent: consentData.consent,
              consentDate: consentData.consentDate ? new Date(consentData.consentDate) : undefined,
              onConsentChange: async (consent: boolean) => {
                const response = await fetch(`http://localhost:3001/companies/${companyId}/consent`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ consent }),
                });

                if (!response.ok) {
                  throw new Error('Failed to update consent');
                }

                const updated = await response.json();
                consentData = updated;
              },
            })
          );
        }
      } catch (error) {
        console.error('Failed to hydrate consent manager:', error);
      }
    }

    // Hydrate CohortBuilder component
    async function hydrateCohortBuilder() {
      try {
        const { default: CohortBuilder } = await import('../../../../components/benchmarks/CohortBuilder');
        const { createRoot } = await import('react-dom/client');
        const { createElement } = await import('react');

        const container = document.getElementById('cohort-builder-section');
        if (container) {
          const root = createRoot(container);
          root.render(
            createElement(CohortBuilder, {
              companyId,
              onCohortChange: handleCohortChange,
              savedCohorts: [], // TODO: Fetch saved cohorts from API
            })
          );
        }
      } catch (error) {
        console.error('Failed to hydrate cohort builder:', error);
      }
    }

    // Handle cohort change from CohortBuilder
    async function handleCohortChange(cohort: CohortDefinition) {
      currentCohort = cohort;
      await fetchBenchmarks();
    }

    // Fetch benchmarks data
    async function fetchBenchmarks() {
      const loadingState = document.getElementById('loading-state');
      const benchmarksContainer = document.getElementById('benchmarks-container');
      const emptyState = document.getElementById('empty-state');

      if (!loadingState || !benchmarksContainer || !emptyState) return;

      // Show loading
      loadingState.style.display = 'block';
      benchmarksContainer.style.display = 'none';
      emptyState.style.display = 'none';

      if (!currentCohort || !currentCohort.size || currentCohort.size < 5) {
        // Cohort too small or not selected
        loadingState.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      try {
        const params = new URLSearchParams();
        const { industry, region, employeeRange, programType } = currentCohort.dimensions;

        if (industry) params.append('industries', industry.join(','));
        if (region) params.append('regions', region.join(','));
        if (employeeRange) params.append('employee_ranges', employeeRange.join(','));
        if (programType) params.append('program_types', programType.join(','));

        const response = await fetch(
          `http://localhost:3001/companies/${companyId}/benchmarks?${params.toString()}`
        );

        if (response.ok) {
          const data = await response.json();

          if (data.metrics && data.metrics.length > 0) {
            await renderBenchmarks(data);
            loadingState.style.display = 'none';
            benchmarksContainer.style.display = 'block';
          } else {
            loadingState.style.display = 'none';
            emptyState.style.display = 'block';
          }
        } else {
          console.error('Failed to fetch benchmarks:', response.statusText);
          loadingState.style.display = 'none';
          emptyState.style.display = 'block';
        }
      } catch (error) {
        console.error('Error fetching benchmarks:', error);
        loadingState.style.display = 'none';
        emptyState.style.display = 'block';
      }
    }

    // Render benchmark results
    async function renderBenchmarks(data: any) {
      const { default: PercentileRibbon } = await import('../../../../components/benchmarks/PercentileRibbon');
      const { createRoot } = await import('react-dom/client');
      const { createElement } = await import('react');

      const container = document.getElementById('benchmarks-container');
      if (!container) return;

      container.innerHTML = '';

      // Create header
      const header = document.createElement('div');
      header.className = 'benchmarks-header';
      header.innerHTML = `
        <h2>Your Performance vs. Peer Cohort</h2>
        <p class="cohort-summary">
          Cohort: <strong>${data.cohortName || 'Custom Selection'}</strong> ‚Ä¢
          <strong>${data.cohortSize || currentCohort?.size || 0}</strong> companies ‚Ä¢
          Last updated: ${new Date(data.lastUpdated || Date.now()).toLocaleDateString()}
        </p>
      `;
      container.appendChild(header);

      // Create metrics grid
      const metricsGrid = document.createElement('div');
      metricsGrid.className = 'metrics-grid';
      container.appendChild(metricsGrid);

      // Render each metric
      for (const metric of data.metrics) {
        const metricContainer = document.createElement('div');
        metricsGrid.appendChild(metricContainer);

        const root = createRoot(metricContainer);
        root.render(
          createElement(PercentileRibbon, {
            metric: {
              name: metric.name,
              unit: metric.unit,
              p10: metric.p10,
              p50: metric.p50,
              p90: metric.p90,
              yourValue: metric.yourValue,
              dpApplied: metric.dpApplied ?? true,
            },
          })
        );
      }
    }

    // Initialize on load
    init();
  </script>

  <style>
    .benchmarks-page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px;
    }

    .page-header {
      margin-bottom: 24px;
    }

    .page-header h1 {
      margin: 8px 0 4px 0;
      font-size: 2rem;
      font-weight: 700;
      color: #1f2937;
    }

    .page-header .subtitle {
      margin: 0;
      font-size: 1rem;
      color: #6b7280;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.875rem;
      color: #3b82f6;
      text-decoration: none;
      margin-bottom: 8px;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .back-link:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
      border-radius: 4px;
    }

    .alert-info {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: #dbeafe;
      border-left: 4px solid #3b82f6;
      border-radius: 8px;
      margin-bottom: 24px;
    }

    .alert-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .alert-info strong {
      display: block;
      margin-bottom: 4px;
      color: #1e40af;
      font-weight: 600;
    }

    .alert-info p {
      margin: 0;
      font-size: 0.875rem;
      color: #1e40af;
      line-height: 1.5;
    }

    .loading-container {
      text-align: center;
      padding: 64px 24px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .spinner {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      border: 4px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-container p {
      color: #6b7280;
      font-size: 0.9375rem;
    }

    .empty-state {
      text-align: center;
      padding: 64px 24px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 16px;
    }

    .empty-state h3 {
      margin: 0 0 8px 0;
      font-size: 1.5rem;
      color: #1f2937;
    }

    .empty-state p {
      margin: 0;
      color: #6b7280;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }

    .benchmarks-header {
      margin-bottom: 24px;
    }

    .benchmarks-header h2 {
      margin: 0 0 8px 0;
      font-size: 1.5rem;
      font-weight: 600;
      color: #1f2937;
    }

    .cohort-summary {
      margin: 0;
      font-size: 0.875rem;
      color: #6b7280;
    }

    .metrics-grid {
      display: grid;
      gap: 24px;
    }

    .privacy-notice-footer {
      margin-top: 48px;
      padding: 32px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .privacy-notice-footer h2 {
      margin: 0 0 24px 0;
      font-size: 1.5rem;
      font-weight: 600;
      color: #1f2937;
    }

    .privacy-footer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
    }

    .privacy-footer-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
    }

    .card-icon {
      font-size: 2rem;
      margin-bottom: 12px;
    }

    .privacy-footer-card h3 {
      margin: 0 0 8px 0;
      font-size: 1rem;
      font-weight: 600;
      color: #1f2937;
    }

    .privacy-footer-card p {
      margin: 0;
      font-size: 0.875rem;
      color: #6b7280;
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      .benchmarks-page {
        padding: 16px;
      }

      .page-header h1 {
        font-size: 1.5rem;
      }

      .privacy-notice-footer {
        padding: 20px;
      }

      .privacy-footer-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</BaseLayout>

---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import { hasPermission } from '../../../../utils/rbac';
import ReportsListTable from '../../../../components/reports/ReportsListTable';
import PageHeader from '../../../../components/ui/PageHeader';

// Extract route parameters
const { lang, companyId } = Astro.params;
const user = Astro.locals.user;
const tenantContext = Astro.locals.tenantContext;

// Auth checks
if (!user || !tenantContext) {
  return Astro.redirect('/login');
}

// Verify tenant context
if (tenantContext.companyId !== companyId || tenantContext.lang !== lang) {
  return Astro.redirect(`/${lang}/cockpit/401`);
}

// Check permission
const canGenerateReports = hasPermission(user.role, 'GENERATE_REPORTS');
if (!canGenerateReports) {
  return Astro.redirect(`/${lang}/cockpit/${companyId}?error=no_permission`);
}

// Page titles by language
const pageTitles = {
  en: 'Generated Reports',
  no: 'Genererte Rapporter',
  uk: 'Згенеровані Звіти'
};

const pageTitle = pageTitles[lang as keyof typeof pageTitles] || pageTitles.en;
const pageSubtitles = {
  en: 'View and manage your generated impact reports',
  no: 'Se og administrer dine genererte innvirkningsrapporter',
  uk: 'Переглядайте та керуйте згенерованими звітами про вплив'
};

const pageSubtitle = pageSubtitles[lang as keyof typeof pageSubtitles] || pageSubtitles.en;
---

<BaseLayout title={`${pageTitle} - TEEI Corporate Cockpit`} lang={lang}>
  <div class="reports-page">
    <PageHeader
      title={pageTitle}
      subtitle={pageSubtitle}
      breadcrumbs={[
        { label: 'Dashboard', href: `/${lang}/cockpit/${companyId}` },
        { label: pageTitle },
      ]}
      client:load
    />

    {/* Main Content */}
    <main class="reports-content">
      <div class="reports-container">
        <ReportsListTable 
          companyId={companyId} 
          lang={lang}
          client:load
        />
      </div>
    </main>
  </div>

  <style>
    .reports-page {
      padding: var(--space-24);
      max-width: 1400px;
      margin: 0 auto;
    }

    .reports-content {
      background: var(--color-background);
    }

    .reports-container {
      background-color: var(--color-surface);
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-card);
      border: 1px solid var(--color-border);
      padding: var(--space-24);
      animation: pageEnter 0.3s var(--ease-out) backwards;
      animation-delay: 50ms;
    }

    @keyframes pageEnter {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .reports-page {
        padding: var(--space-16);
      }

      .reports-container {
        padding: var(--space-16);
      }
    }

    @media (prefers-reduced-motion: reduce) {
      .reports-container {
        animation: none;
      }
    }
  </style>
</BaseLayout>

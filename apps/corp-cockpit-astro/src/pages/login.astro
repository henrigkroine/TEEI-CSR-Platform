---
import { detectLanguage, t } from '../lib/i18n';
import BaseLayout from '../layouts/BaseLayout.astro';

// NOTE: Astro provides a global `Astro` object at runtime.
// Some TS tooling configs don't pick up its type in this file, so we declare it.
declare const Astro: any;

const lang = detectLanguage(Astro.request);

const redirect = Astro.url.searchParams.get('redirect') || '/';
const pageTitle = `Sign in - ${t(lang, 'app.title')}`;
const showDemoCredentials = true;
---

<BaseLayout title={pageTitle} lang={lang}>
  <div class="auth-page page-enter">
    <div class="auth-shell">
      <section class="auth-brand" aria-label="Welcome">
        <a class="auth-back" href="/en">‚Üê Back to TEEI.io</a>
        <div class="auth-brand-inner">
          <div class="auth-mark" aria-hidden="true">
            <span class="auth-mark-dot"></span>
          </div>
          <h1 class="auth-title">
            <span class="text-gradient-accent">TEEI</span> Corporate Cockpit
          </h1>
          <p class="auth-subtitle">{t(lang, 'app.subtitle')}</p>

          <ul class="auth-points" aria-label="Highlights">
            <li><span class="auth-bullet"></span> Multi-tenant access controls</li>
            <li><span class="auth-bullet"></span> Real-time KPI updates</li>
            <li><span class="auth-bullet"></span> Evidence-backed reporting</li>
          </ul>
        </div>
      </section>

      <section class="auth-card card" aria-label="Sign in">
        <header class="auth-card-header">
          <div>
            <p class="auth-card-label">Sign in</p>
            <h2 class="auth-card-title">Welcome back</h2>
            <p class="auth-card-subtitle">Use your corporate credentials to continue.</p>
          </div>
          {showDemoCredentials && (
            <span class="badge badge-accent">Demo mode</span>
          )}
        </header>

        <div id="login-error" class="auth-error" role="alert" aria-live="polite" hidden></div>

        <form id="login-form" class="auth-form" novalidate>
          <input type="hidden" name="redirect" value={redirect} />

          <label class="auth-field">
            <span class="auth-label">Email</span>
            <input
              id="email"
              name="email"
              type="email"
              autocomplete="email"
              class="input"
              placeholder="you@company.com"
              required
            />
          </label>

          <label class="auth-field">
            <span class="auth-label">Password</span>
            <div class="auth-password">
              <input
                id="password"
                name="password"
                type="password"
                autocomplete="current-password"
                class="input auth-password-input"
                placeholder="Enter your password"
                required
              />
              <button class="auth-password-toggle" type="button" aria-label="Show password" aria-pressed="false">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path
                    fill="currentColor"
                    d="M12 5c5.5 0 9.6 4.2 10.9 6.1.2.3.2.6 0 .9C21.6 13.8 17.5 18 12 18S2.4 13.8 1.1 12c-.2-.3-.2-.6 0-.9C2.4 9.2 6.5 5 12 5zm0 2c-3.9 0-7.1 2.9-8.6 4.5 1.5 1.6 4.7 4.5 8.6 4.5s7.1-2.9 8.6-4.5C19.1 9.9 15.9 7 12 7zm0 1.5A3.5 3.5 0 1 1 12 16a3.5 3.5 0 0 1 0-7.5zm0 2A1.5 1.5 0 1 0 12 14a1.5 1.5 0 0 0 0-3.5z"
                  />
                </svg>
              </button>
            </div>
          </label>

          <div class="auth-row">
            <label class="auth-check">
              <input id="remember-me" name="rememberMe" type="checkbox" />
              <span>Remember me</span>
            </label>
            <a class="auth-link" href="/forgot-password">Forgot password?</a>
          </div>

          <button id="login-submit" class="btn btn-primary btn-lg press-effect" type="submit">
            <span class="auth-btn-label">Sign in</span>
            <span id="login-spinner" class="auth-spinner" aria-hidden="true" hidden></span>
          </button>

          {showDemoCredentials && (
            <div class="auth-demo">
              <p class="auth-demo-title">Demo credentials</p>
              <div class="auth-demo-grid">
                <button class="auth-demo-pill" type="button" data-demo-email="admin@acme.com" data-demo-password="admin123">
                  Admin
                </button>
                <button class="auth-demo-pill" type="button" data-demo-email="manager@acme.com" data-demo-password="manager123">
                  Manager
                </button>
                <button class="auth-demo-pill" type="button" data-demo-email="viewer@acme.com" data-demo-password="viewer123">
                  Viewer
                </button>
              </div>
              <p class="auth-demo-footnote">This is a development-only login flow.</p>
            </div>
          )}
        </form>

        <footer class="auth-footnote">
          <span class="badge badge-outline">Demo</span>
          <span>In production, authentication is handled via SSO / API Gateway.</span>
        </footer>
      </section>
    </div>
  </div>

  <script is:inline>
    (function () {
      const form = document.getElementById('login-form');
      const errorEl = document.getElementById('login-error');
      const submitBtn = document.getElementById('login-submit');
      const spinner = document.getElementById('login-spinner');
      const passwordInput = document.getElementById('password');
      const passwordToggle = document.querySelector('.auth-password-toggle');

      function setError(message) {
        if (!errorEl) return;
        if (!message) {
          errorEl.hidden = true;
          errorEl.textContent = '';
          return;
        }
        errorEl.textContent = message;
        errorEl.hidden = false;
      }

      function setLoading(isLoading) {
        if (submitBtn) submitBtn.toggleAttribute('disabled', isLoading);
        if (spinner) spinner.hidden = !isLoading;
      }

      function safeRedirect(target) {
        if (typeof target !== 'string') return '/';
        // Prevent open-redirects: allow only same-origin paths
        if (!target.startsWith('/')) return '/';
        return target;
      }

      if (passwordToggle && passwordInput) {
        passwordToggle.addEventListener('click', () => {
          const isHidden = passwordInput.getAttribute('type') === 'password';
          passwordInput.setAttribute('type', isHidden ? 'text' : 'password');
          passwordToggle.setAttribute('aria-pressed', String(isHidden));
          passwordToggle.setAttribute('aria-label', isHidden ? 'Hide password' : 'Show password');
        });
      }

      document.querySelectorAll('[data-demo-email][data-demo-password]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const email = btn.getAttribute('data-demo-email') || '';
          const password = btn.getAttribute('data-demo-password') || '';
          const emailInput = document.getElementById('email');
          if (emailInput) emailInput.value = email;
          if (passwordInput) passwordInput.value = password;
          setError('');
          if (emailInput) emailInput.focus();
        });
      });

      if (!form) return;
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setError('');

        const fd = new FormData(form);
        const email = String(fd.get('email') || '').trim();
        const password = String(fd.get('password') || '');
        const redirect = safeRedirect(String(fd.get('redirect') || '/'));

        if (!email || !password) {
          setError('Please enter your email and password.');
          return;
        }

        setLoading(true);
        try {
          const res = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            setError(data?.message || data?.error || 'Unable to sign in. Please try again.');
            setLoading(false);
            return;
          }

          window.location.assign(redirect);
        } catch (err) {
          setError('Network error. Please try again.');
          setLoading(false);
        }
      });
    })();
  </script>

  <style>
    .auth-page {
      min-height: 100vh;
      padding: 40px 20px;
      background: radial-gradient(1200px 600px at 20% 20%, rgba(186, 143, 90, 0.25), transparent 55%),
        linear-gradient(135deg, #00393f 0%, #01272a 100%);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .auth-shell {
      width: 100%;
      max-width: 1040px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
      align-items: stretch;
    }

    @media (min-width: 960px) {
      .auth-shell {
        grid-template-columns: 1.05fr 0.95fr;
        gap: 24px;
      }
    }

    .auth-brand {
      color: rgba(255, 255, 255, 0.92);
      border-radius: 20px;
      padding: 28px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .auth-back {
      display: inline-block;
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 18px;
    }
    .auth-back:hover { color: #BA8F5A; }

    .auth-brand-inner { max-width: 460px; }

    .auth-mark {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: rgba(186, 143, 90, 0.18);
      border: 1px solid rgba(186, 143, 90, 0.35);
      display: grid;
      place-items: center;
      margin-bottom: 14px;
    }
    .auth-mark-dot {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #BA8F5A;
      box-shadow: 0 0 0 6px rgba(186, 143, 90, 0.18);
    }

    .auth-title {
      color: white;
      font-size: 34px;
      line-height: 1.1;
      margin: 0;
    }

    .auth-subtitle {
      margin-top: 10px;
      color: rgba(255, 255, 255, 0.78);
      font-size: 15px;
      line-height: 1.6;
    }

    .auth-points {
      list-style: none;
      padding: 0;
      margin: 18px 0 0;
      display: grid;
      gap: 10px;
      color: rgba(255, 255, 255, 0.82);
      font-size: 14px;
    }

    .auth-bullet {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(186, 143, 90, 0.9);
      margin-right: 10px;
      transform: translateY(-1px);
      box-shadow: 0 0 0 4px rgba(186, 143, 90, 0.15);
    }

    .auth-card {
      padding: 24px;
      border-radius: 20px;
    }

    .auth-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .auth-card-title {
      margin: 6px 0 0;
      font-size: 26px;
    }

    .auth-card-label {
      font-size: var(--text-xs);
      font-weight: var(--font-weight-semibold);
      letter-spacing: var(--tracking-caps);
      color: var(--color-text-tertiary);
      margin: 0;
      text-transform: none;
    }

    .auth-card-subtitle {
      margin: 8px 0 0;
      color: var(--color-text-secondary);
      font-size: 14px;
      line-height: 1.5;
    }

    .auth-form {
      display: grid;
      gap: 14px;
    }

    .auth-field { display: grid; gap: 8px; }
    .auth-label { font-size: 12px; letter-spacing: var(--tracking-caps); text-transform: uppercase; color: var(--color-text-tertiary); font-weight: var(--font-weight-semibold); }

    .auth-password { position: relative; display: grid; }
    .auth-password-input { padding-right: 44px; }
    .auth-password-toggle {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      color: var(--color-text-secondary);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: background var(--duration-fast) var(--ease-out), border-color var(--duration-fast) var(--ease-out);
    }
    .auth-password-toggle:hover {
      background: var(--color-muted);
      border-color: var(--color-border-strong);
      color: var(--color-text-primary);
    }

    .auth-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-top: 2px;
    }

    .auth-check {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: var(--color-text-secondary);
    }
    .auth-check input { width: 18px; height: 18px; }

    .auth-link {
      font-size: 14px;
      color: var(--color-primary-light);
      text-decoration: none;
      font-weight: 600;
    }
    .auth-link:hover { text-decoration: underline; }

    .auth-error {
      border-radius: 14px;
      padding: 12px 14px;
      border: 1px solid rgba(220, 38, 38, 0.25);
      background: rgba(220, 38, 38, 0.08);
      color: #991b1b;
      font-size: 14px;
      line-height: 1.4;
      margin-bottom: 12px;
    }
    [data-theme="dark"] .auth-error,
    html.dark .auth-error {
      color: #fecaca;
      border-color: rgba(248, 113, 113, 0.35);
      background: rgba(248, 113, 113, 0.12);
    }

    .auth-spinner {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.35);
      border-top-color: white;
      animation: authSpin 0.8s linear infinite;
      margin-left: 10px;
    }
    @keyframes authSpin { to { transform: rotate(360deg); } }

    .auth-demo {
      margin-top: 10px;
      padding: 14px;
      border-radius: 16px;
      border: 1px solid var(--color-border);
      background: var(--color-surface-alt);
    }
    .auth-demo-title {
      margin: 0 0 10px;
      font-size: 12px;
      font-weight: var(--font-weight-semibold);
      letter-spacing: var(--tracking-caps);
      text-transform: uppercase;
      color: var(--color-text-tertiary);
    }
    .auth-demo-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    .auth-demo-pill {
      border-radius: 999px;
      border: 1px solid var(--color-border);
      background: var(--color-surface);
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background var(--duration-fast) var(--ease-out), border-color var(--duration-fast) var(--ease-out);
    }
    .auth-demo-pill:hover {
      background: rgba(186, 143, 90, 0.08);
      border-color: rgba(186, 143, 90, 0.35);
    }
    .auth-demo-footnote {
      margin: 10px 0 0;
      font-size: 12px;
      color: var(--color-text-secondary);
    }

    .auth-footnote {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 16px;
      padding-top: 14px;
      border-top: 1px solid var(--color-border-subtle);
      color: var(--color-text-tertiary);
      font-size: 12px;
    }
  </style>
</BaseLayout>

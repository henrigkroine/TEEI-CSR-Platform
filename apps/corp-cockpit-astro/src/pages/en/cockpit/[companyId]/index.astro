---
import CockpitLayout from '@layouts/CockpitLayout.astro';
import MetricCard from '@components/shared/MetricCard';
import DashboardActions from '@components/dashboard/DashboardActions';
import ActionableItems from '@components/dashboard/ActionableItems';
import CampaignPipeline from '@components/dashboard/CampaignPipeline';
import AIInsights from '@components/dashboard/AIInsights';
import ComplianceAlerts from '@components/dashboard/ComplianceAlerts';

const { companyId: companyIdFromParams } = Astro.params;
const tenantContext = Astro.locals.tenantContext;

// Use companyId from tenantContext as fallback if params is undefined
const companyId = companyIdFromParams || tenantContext?.companyId;

// Validate companyId exists
if (!companyId || companyId === 'undefined') {
  console.error('[Dashboard] Invalid companyId:', { companyIdFromParams, tenantContext });
  return Astro.redirect('/login');
}

// TODO: Fetch company data and verify access
// const company = await fetchCompany(companyId);
// if (!company) return Astro.redirect('/en');

// Mock company data
const company = {
  id: companyId,
  name: 'Pilot Corp Inc.',
};
---

<CockpitLayout
  title="Dashboard"
  lang="en"
  companyId={companyId}
  companyName={company.name}
>
  <div class="mx-auto max-w-[1600px] space-y-8 px-6 py-10">
    <header class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.4em] text-text-tertiary">Executive cockpit</p>
        <h1 class="text-3xl font-semibold text-text-primary">Experience Blueprint Snapshot</h1>
        <p class="text-sm text-text-secondary">Teal scaffolding, gold accents, and actionable insights for {company.name}.</p>
      </div>
      <div class="w-full max-w-sm">
        <DashboardActions companyId={companyId!} client:load />
      </div>
    </header>

    <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-4">
      <MetricCard
        metricId="sroi"
        label="SROI"
        value="3.2x"
        change="+12% QoQ"
        changePositive={true}
        showLineage={true}
        badge="Core KPI"
        subtitle="Social Return on Investment"
        trend={[58, 61, 64, 70, 76, 82]}
        client:load
      />

      <MetricCard
        metricId="vis"
        label="VIS Score"
        value={85}
        change="+5 pts from last quarter"
        changePositive={true}
        showLineage={true}
        badge="Engagement"
        subtitle="Volunteer Impact Score"
        trend={[72, 74, 75, 78, 80, 85]}
        client:load
      />

      <MetricCard
        metricId="participants"
        label="Active Participants"
        value={247}
        change="+38 net new"
        changePositive={true}
        showLineage={false}
        badge="People"
        subtitle="Across programs"
        trend={[210, 218, 223, 232, 247, 247]}
        client:load
      />

      <MetricCard
        metricId="integration_score"
        label="Integration Score"
        value={0.78}
        change="+8% QoQ"
        changePositive={true}
        showLineage={true}
        badge="Composite"
        subtitle="Integration confidence"
        trend={[0.62, 0.66, 0.7, 0.73, 0.78, 0.78].map((value) => value * 100)}
        client:load
      />
    </div>

    <div class="grid gap-6 xl:grid-cols-[minmax(0,1.05fr)_minmax(0,0.95fr)]">
      <div class="space-y-6">
        <ActionableItems client:load companyId={companyId} />
        <CampaignPipeline client:load companyId={companyId} />
      </div>
      <div class="space-y-6">
        <AIInsights client:load companyId={companyId} />
        <ComplianceAlerts client:load companyId={companyId} />
      </div>
    </div>
  </div>
</CockpitLayout>

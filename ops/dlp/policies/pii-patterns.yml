# DLP Policies: PII Detection Patterns
# Regular expressions and patterns for detecting sensitive data

patterns:
  # Email addresses
  - id: pii-email
    name: "Email Address"
    category: pii
    severity: medium
    regex: '\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'
    description: "Detects email addresses"
    examples:
      - "user@example.com"
      - "john.doe@company.org"

  # Phone numbers (US/UK/International)
  - id: pii-phone-us
    name: "US Phone Number"
    category: pii
    severity: medium
    regex: '\b(\+1[-.\s]?)?(\(?\d{3}\)?[-.\s]?)?\d{3}[-.\s]?\d{4}\b'
    description: "Detects US phone numbers"
    examples:
      - "+1-555-123-4567"
      - "(555) 123-4567"
      - "555.123.4567"

  # Social Security Numbers (US)
  - id: pii-ssn
    name: "Social Security Number"
    category: pii
    severity: critical
    regex: '\b\d{3}-\d{2}-\d{4}\b'
    description: "Detects US SSN (XXX-XX-XXXX format)"
    examples:
      - "123-45-6789"

  # Credit card numbers (Luhn algorithm)
  - id: pii-credit-card
    name: "Credit Card Number"
    category: financial
    severity: critical
    regex: '\b(?:4\d{3}|5[1-5]\d{2}|6011|3[47]\d{2})[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b'
    description: "Detects credit card numbers (Visa, MasterCard, Amex, Discover)"
    examples:
      - "4111-1111-1111-1111"
      - "5500 0000 0000 0004"

  # IBAN (International Bank Account Number)
  - id: pii-iban
    name: "IBAN"
    category: financial
    severity: critical
    regex: '\b[A-Z]{2}\d{2}[A-Z0-9]{1,30}\b'
    description: "Detects IBAN codes"
    examples:
      - "GB82WEST12345698765432"
      - "DE89370400440532013000"

  # Passport numbers (generic pattern)
  - id: pii-passport
    name: "Passport Number"
    category: pii
    severity: critical
    regex: '\b[A-Z]{1,2}\d{6,9}\b'
    description: "Detects passport numbers"
    examples:
      - "AB1234567"
      - "P12345678"

  # IP addresses (IPv4)
  - id: pii-ipv4
    name: "IPv4 Address"
    category: technical
    severity: low
    regex: '\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b'
    description: "Detects IPv4 addresses"
    examples:
      - "192.168.1.1"
      - "10.0.0.1"

  # API keys (generic patterns)
  - id: secret-api-key
    name: "API Key"
    category: secret
    severity: critical
    regex: '\b[A-Za-z0-9_-]{32,}\b'
    description: "Detects potential API keys (32+ alphanumeric characters)"
    context_keywords: ["api_key", "apikey", "token", "secret"]

  # AWS Access Keys
  - id: secret-aws-access-key
    name: "AWS Access Key"
    category: secret
    severity: critical
    regex: '\bAKIA[0-9A-Z]{16}\b'
    description: "Detects AWS access keys"
    examples:
      - "AKIAIOSFODNN7EXAMPLE"

  # JWT tokens
  - id: secret-jwt
    name: "JWT Token"
    category: secret
    severity: high
    regex: '\beyJ[A-Za-z0-9_-]+\.eyJ[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\b'
    description: "Detects JWT tokens"
    examples:
      - "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIn0.dozjgNryP4J3jVmNHl0w5N_XgL0n3I9PlFUP0THsR8U"

  # Private keys (PEM format)
  - id: secret-private-key
    name: "Private Key (PEM)"
    category: secret
    severity: critical
    regex: '-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY-----'
    description: "Detects PEM-formatted private keys"

  # National Insurance Number (UK)
  - id: pii-ni-number
    name: "UK National Insurance Number"
    category: pii
    severity: critical
    regex: '\b[A-CEGHJ-PR-TW-Z]{1}[A-CEGHJ-NPR-TW-Z]{1}[0-9]{6}[A-D]{1}\b'
    description: "Detects UK National Insurance numbers"
    examples:
      - "AB123456C"

  # EU VAT numbers
  - id: pii-vat
    name: "EU VAT Number"
    category: financial
    severity: medium
    regex: '\b(AT|BE|BG|CY|CZ|DE|DK|EE|EL|ES|FI|FR|GB|HR|HU|IE|IT|LT|LU|LV|MT|NL|PL|PT|RO|SE|SI|SK)U?[0-9]{8,12}\b'
    description: "Detects EU VAT numbers"

  # Health Insurance Claim Number (HICN) - US
  - id: pii-hicn
    name: "Health Insurance Claim Number"
    category: health
    severity: critical
    regex: '\b\d{3}-\d{2}-\d{4}[A-Z]{1}\d{1}\b'
    description: "Detects US HICN numbers"

  # Driver's License (US - generic)
  - id: pii-drivers-license
    name: "Driver's License Number"
    category: pii
    severity: high
    regex: '\b[A-Z]{1,2}\d{5,8}\b'
    description: "Detects potential driver's license numbers"

actions:
  - name: quarantine
    description: "Move file to quarantine bucket"
    retention: 90d

  - name: redact
    description: "Redact detected patterns and save sanitized version"
    redaction_char: "X"

  - name: alert
    description: "Send alert to security team"
    channels:
      - slack
      - email
      - pagerduty

  - name: block_upload
    description: "Prevent file upload if patterns detected"

  - name: encrypt_at_rest
    description: "Enforce encryption for files with sensitive data"

thresholds:
  critical:
    action: quarantine
    alert_immediately: true
    notify:
      - security_team
      - dpo
      - ciso

  high:
    action: encrypt_at_rest
    alert_immediately: true
    notify:
      - security_team

  medium:
    action: redact
    alert_immediately: false
    notify:
      - data_owner

  low:
    action: audit_log
    alert_immediately: false

metadata:
  version: "1.0.0"
  updated: "2025-11-15"
  author: "Worker 4 Phase H2 - DLP Scanner Author"
  compliance:
    - GDPR-Art32  # Security of processing
    - SOC2-CC6.7  # Data loss prevention
    - PCI-DSS-3.4  # Protect cardholder data
    - HIPAA-164.312  # Technical safeguards

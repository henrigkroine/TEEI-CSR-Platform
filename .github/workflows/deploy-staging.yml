name: Deploy to Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to deploy (default: staging)'
        required: false
        default: 'staging'

env:
  KUBE_NAMESPACE: teei-staging
  ENVIRONMENT: staging

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.teei.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Setup kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.0.0'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > /tmp/kubeconfig
          echo "KUBECONFIG=/tmp/kubeconfig" >> $GITHUB_ENV

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Verify secrets exist
        run: |
          echo "Checking for required secrets in ${KUBE_NAMESPACE}..."

          # List of required secrets
          REQUIRED_SECRETS=(
            "teei-api-gateway-secrets"
            "teei-unified-profile-secrets"
            "teei-q2q-ai-secrets"
            "teei-analytics-secrets"
            "teei-discord-bot-secrets"
            "teei-corp-cockpit-secrets"
          )

          MISSING_SECRETS=()

          for secret in "${REQUIRED_SECRETS[@]}"; do
            if ! kubectl get secret "${secret}" -n ${KUBE_NAMESPACE} &>/dev/null; then
              MISSING_SECRETS+=("${secret}")
              echo "❌ Missing: ${secret}"
            else
              echo "✅ Found: ${secret}"
            fi
          done

          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo ""
            echo "⚠️  WARNING: ${#MISSING_SECRETS[@]} secret(s) not found in cluster!"
            echo "Deployments may fail if these secrets are required."
            echo ""
            echo "To create secrets, choose one of these methods:"
            echo "1. Sealed Secrets: See k8s/base/secrets/SEALED_SECRETS.md"
            echo "2. Vault: See k8s/base/secrets/VAULT_INTEGRATION.md"
            echo "3. SOPS: See k8s/base/secrets/SOPS_INTEGRATION.md"
            echo ""
            echo "For manual creation (not recommended for production):"
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "  kubectl create secret generic ${secret} -n ${KUBE_NAMESPACE} --from-literal=KEY=VALUE"
            done

            # Don't fail the workflow, just warn
            # Uncomment the next line to make this a hard requirement
            # exit 1
          else
            echo ""
            echo "✅ All required secrets are present"
          fi

      - name: Update image tags
        run: |
          cd k8s/overlays/staging
          IMAGE_TAG=${{ github.event.inputs.image_tag || 'staging' }}

          # Update all image tags to the specified version
          kustomize edit set image \
            ghcr.io/${{ github.repository_owner }}/teei-api-gateway:${IMAGE_TAG} \
            ghcr.io/${{ github.repository_owner }}/teei-unified-profile:${IMAGE_TAG} \
            ghcr.io/${{ github.repository_owner }}/teei-kintell-connector:${IMAGE_TAG} \
            ghcr.io/${{ github.repository_owner }}/teei-buddy-service:${IMAGE_TAG} \
            ghcr.io/${{ github.repository_owner }}/teei-upskilling-connector:${IMAGE_TAG} \
            ghcr.io/${{ github.repository_owner }}/teei-q2q-ai:${IMAGE_TAG} \
            ghcr.io/${{ github.repository_owner }}/teei-safety-moderation:${IMAGE_TAG} \
            ghcr.io/${{ github.repository_owner }}/teei-analytics:${IMAGE_TAG} \
            ghcr.io/${{ github.repository_owner }}/teei-buddy-connector:${IMAGE_TAG} \
            ghcr.io/${{ github.repository_owner }}/teei-discord-bot:${IMAGE_TAG} \
            ghcr.io/${{ github.repository_owner }}/teei-impact-calculator:${IMAGE_TAG} \
            ghcr.io/${{ github.repository_owner }}/teei-impact-in:${IMAGE_TAG} \
            ghcr.io/${{ github.repository_owner }}/teei-journey-engine:${IMAGE_TAG} \
            ghcr.io/${{ github.repository_owner }}/teei-notifications:${IMAGE_TAG} \
            ghcr.io/${{ github.repository_owner }}/teei-reporting:${IMAGE_TAG} \
            ghcr.io/${{ github.repository_owner }}/teei-corp-cockpit:${IMAGE_TAG}

      - name: Apply sealed secrets (if using Sealed Secrets)
        run: |
          echo "Checking for sealed secrets..."

          SEALED_SECRETS_DIR="k8s/overlays/staging/sealed-secrets"

          if [ -d "${SEALED_SECRETS_DIR}" ] && [ -n "$(ls -A ${SEALED_SECRETS_DIR}/*.yaml 2>/dev/null)" ]; then
            echo "Found sealed secrets, applying..."
            kubectl apply -f ${SEALED_SECRETS_DIR}/ -n ${KUBE_NAMESPACE} || true

            # Wait for sealed secrets controller to decrypt
            echo "Waiting 10 seconds for sealed secrets to be decrypted..."
            sleep 10
          else
            echo "No sealed secrets found at ${SEALED_SECRETS_DIR}"
            echo "Skipping sealed secrets application"
          fi

      - name: Run database migrations (gate)
        run: |
          echo "=========================================="
          echo "Running Database Migrations"
          echo "=========================================="

          # Delete any existing migration job (from previous runs)
          kubectl delete job db-migration -n ${KUBE_NAMESPACE} --ignore-not-found=true

          # Wait for job deletion to complete
          echo "Waiting for previous job cleanup..."
          sleep 5

          # Apply the migration job manifest
          echo "Creating migration job..."
          kubectl apply -f k8s/jobs/db-migration.yaml -n ${KUBE_NAMESPACE}

          # Wait for job to start
          echo "Waiting for job to start..."
          kubectl wait --for=condition=Ready pod -l app=db-migration -n ${KUBE_NAMESPACE} --timeout=60s || {
            echo "⚠️  Job pod not ready yet, checking status..."
            kubectl get pods -l app=db-migration -n ${KUBE_NAMESPACE}
          }

          # Stream job logs
          echo ""
          echo "Migration job logs:"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          kubectl logs -f job/db-migration -n ${KUBE_NAMESPACE} --all-containers=true || {
            echo "⚠️  Could not stream logs, will check pod status..."
          }

          # Wait for job to complete (max 10 minutes)
          echo ""
          echo "Waiting for migration job to complete..."
          kubectl wait --for=condition=Complete job/db-migration -n ${KUBE_NAMESPACE} --timeout=600s || {
            echo "❌ Migration job failed or timed out!"
            echo ""
            echo "Job status:"
            kubectl describe job db-migration -n ${KUBE_NAMESPACE}
            echo ""
            echo "Pod logs:"
            kubectl logs job/db-migration -n ${KUBE_NAMESPACE} --all-containers=true --tail=100
            echo ""
            echo "⚠️  DEPLOYMENT ABORTED - Fix migrations and retry"
            exit 1
          }

          # Check if job succeeded
          JOB_STATUS=$(kubectl get job db-migration -n ${KUBE_NAMESPACE} -o jsonpath='{.status.conditions[?(@.type=="Complete")].status}')
          if [ "$JOB_STATUS" != "True" ]; then
            echo "❌ Migration job did not complete successfully"
            kubectl describe job db-migration -n ${KUBE_NAMESPACE}
            exit 1
          fi

          echo ""
          echo "✅ Database migrations completed successfully"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          # Show migration summary
          echo ""
          echo "Migration job summary:"
          kubectl describe job db-migration -n ${KUBE_NAMESPACE} | grep -A 5 "Status:"

          echo ""
          echo "Ready to deploy services..."

      - name: Render manifests
        run: |
          kubectl kustomize k8s/overlays/staging > /tmp/staging-manifests.yaml
          echo "Generated manifests:"
          head -n 50 /tmp/staging-manifests.yaml

      - name: Dry-run deployment
        run: |
          kubectl apply --dry-run=server -f /tmp/staging-manifests.yaml

      - name: Deploy to staging
        run: |
          kubectl apply -f /tmp/staging-manifests.yaml
          kubectl rollout status deployment -n ${KUBE_NAMESPACE} --timeout=10m

      - name: Wait for all deployments to be ready
        run: |
          kubectl wait --for=condition=available --timeout=10m \
            -n ${KUBE_NAMESPACE} \
            deployment --all

      - name: Run smoke tests
        run: |
          echo "Running comprehensive smoke tests..."
          echo "Testing all 16 services + critical E2E paths"
          echo ""

          # Export environment variables for the smoke test script
          export KUBE_NAMESPACE=${KUBE_NAMESPACE}
          export MAX_RETRIES=3
          export RETRY_DELAY=10
          export TIMEOUT=300

          # Run the smoke test script
          if ./scripts/smoke-tests.sh; then
            echo ""
            echo "✅ All smoke tests passed successfully!"
            echo ""
          else
            echo ""
            echo "❌ Smoke tests failed!"
            echo ""
            echo "Deployment will be rolled back..."
            echo ""
            echo "Fetching recent events for debugging:"
            kubectl get events -n ${KUBE_NAMESPACE} --sort-by='.lastTimestamp' | tail -20
            echo ""
            echo "Pod status:"
            kubectl get pods -n ${KUBE_NAMESPACE} -o wide
            exit 1
          fi

      - name: Rollback on failure
        if: failure()
        run: |
          echo "================================================================"
          echo "   SMOKE TESTS FAILED - INITIATING ROLLBACK"
          echo "================================================================"
          echo ""
          echo "Rolling back all deployments to previous revision..."
          echo ""

          # Get all deployments in the namespace
          DEPLOYMENTS=$(kubectl get deployments -n ${KUBE_NAMESPACE} -o jsonpath='{.items[*].metadata.name}')

          # Rollback each deployment
          for deployment in $DEPLOYMENTS; do
            echo "Rolling back: ${deployment}"
            kubectl rollout undo deployment/${deployment} -n ${KUBE_NAMESPACE} || true
          done

          echo ""
          echo "Waiting for rollback to complete..."
          kubectl rollout status deployment -n ${KUBE_NAMESPACE} --timeout=5m || true

          echo ""
          echo "Rollback completed. Checking pod status:"
          kubectl get pods -n ${KUBE_NAMESPACE}

          echo ""
          echo "================================================================"
          echo "   ROLLBACK COMPLETE - DEPLOYMENT FAILED"
          echo "================================================================"

      - name: Verify health checks
        run: |
          # Get all pods and check their health
          kubectl get pods -n ${KUBE_NAMESPACE}

          # Check if all pods are running
          NOT_READY=$(kubectl get pods -n ${KUBE_NAMESPACE} --field-selector=status.phase!=Running --no-headers | wc -l)
          if [ "$NOT_READY" -gt "0" ]; then
            echo "ERROR: $NOT_READY pods are not running"
            kubectl get pods -n ${KUBE_NAMESPACE}
            exit 1
          fi

          echo "All pods are healthy"

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** staging" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** ${KUBE_NAMESPACE}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ github.event.inputs.image_tag || 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Services" >> $GITHUB_STEP_SUMMARY
          kubectl get deployments -n ${KUBE_NAMESPACE} -o wide >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Secrets Status" >> $GITHUB_STEP_SUMMARY
          kubectl get secrets -n ${KUBE_NAMESPACE} | grep "teei-" >> $GITHUB_STEP_SUMMARY || echo "No TEEI secrets found" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "Deployment failed! Check logs and pod status."
          kubectl get events -n ${KUBE_NAMESPACE} --sort-by='.lastTimestamp' | tail -20

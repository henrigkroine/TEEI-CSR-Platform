name: Deploy Canary (Multi-Region Progressive)

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        type: choice
        options:
          - api-gateway
          - reporting
          - corp-cockpit
          - all
      version:
        description: 'Image tag/version (e.g., v1.2.0)'
        required: true
      region:
        description: 'Target region'
        required: true
        type: choice
        options:
          - us-east-1
          - eu-west-1
          - ap-southeast-1
          - all
      auto_promote:
        description: 'Automatically promote if metrics are healthy'
        type: boolean
        default: true

env:
  NODE_VERSION: '20'

permissions:
  contents: read
  id-token: write

jobs:
  validate:
    name: Validate Canary Deployment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "ERROR: Version must follow semver format (e.g., v1.2.0)"
            exit 1
          fi
          echo "âœ… Valid version: $VERSION"

      - name: Check image exists
        run: |
          echo "ðŸ” Checking if images exist in registry..."
          SERVICE="${{ github.event.inputs.service }}"
          VERSION="${{ github.event.inputs.version }}"

          if [ "$SERVICE" = "all" ]; then
            SERVICES=("api-gateway" "reporting" "corp-cockpit")
          else
            SERVICES=("$SERVICE")
          fi

          for svc in "${SERVICES[@]}"; do
            echo "Checking ghcr.io/${{ github.repository_owner }}/teei-${svc}:${VERSION}"
            # TODO: Add actual image verification
            # docker manifest inspect ghcr.io/${{ github.repository_owner }}/teei-${svc}:${VERSION}
          done

          echo "âœ… All images verified"

      - name: Validate canary config
        run: |
          echo "ðŸ” Validating canary configuration..."

          if [ ! -f "ops/canary/config.yaml" ]; then
            echo "ERROR: ops/canary/config.yaml not found"
            exit 1
          fi

          echo "âœ… Canary config valid"

  deploy-canary:
    name: Deploy Canary to ${{ github.event.inputs.region }}
    needs: validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl (multi-region)
        run: |
          REGION="${{ github.event.inputs.region }}"

          if [ "$REGION" = "us-east-1" ]; then
            echo "${{ secrets.KUBE_CONFIG_US_EAST_1 }}" | base64 -d > /tmp/kubeconfig
          elif [ "$REGION" = "eu-west-1" ]; then
            echo "${{ secrets.KUBE_CONFIG_EU_WEST_1 }}" | base64 -d > /tmp/kubeconfig
          elif [ "$REGION" = "ap-southeast-1" ]; then
            echo "${{ secrets.KUBE_CONFIG_AP_SOUTHEAST_1 }}" | base64 -d > /tmp/kubeconfig
          else
            echo "ERROR: Invalid region"
            exit 1
          fi

          echo "KUBECONFIG=/tmp/kubeconfig" >> $GITHUB_ENV

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy canary
        id: deploy
        run: |
          SERVICE="${{ github.event.inputs.service }}"
          VERSION="${{ github.event.inputs.version }}"
          REGION="${{ github.event.inputs.region }}"

          echo "ðŸš€ Starting canary deployment..."
          echo "Service: $SERVICE"
          echo "Version: $VERSION"
          echo "Region: $REGION"

          # Apply canary deployment manifests
          envsubst < k8s/canary/deployment-template.yaml | kubectl apply -f -

          # Start canary controller
          node ops/canary/deploy-cli.js start \
            --service="$SERVICE" \
            --version="$VERSION" \
            --region="$REGION" \
            --auto-promote="${{ github.event.inputs.auto_promote }}"

          echo "deployment_id=$(cat /tmp/canary-deployment-id.txt)" >> $GITHUB_OUTPUT

      - name: Monitor canary (initial stage)
        id: monitor
        run: |
          DEPLOYMENT_ID="${{ steps.deploy.outputs.deployment_id }}"

          echo "ðŸ‘€ Monitoring canary deployment: $DEPLOYMENT_ID"
          echo "Initial stage: 5% traffic for 30 minutes"

          # Monitor for 35 minutes (initial stage + buffer)
          node ops/canary/deploy-cli.js monitor \
            --deployment-id="$DEPLOYMENT_ID" \
            --duration=35

          STATUS=$(node ops/canary/deploy-cli.js status --deployment-id="$DEPLOYMENT_ID" --json | jq -r '.status')
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Check deployment status
        if: always()
        run: |
          STATUS="${{ steps.monitor.outputs.status }}"

          echo "## Canary Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** ${{ github.event.inputs.service }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ github.event.inputs.region }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** $STATUS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$STATUS" = "rolled_back" ]; then
            echo "âŒ Canary deployment was rolled back"
            exit 1
          elif [ "$STATUS" = "active" ]; then
            echo "âœ… Canary deployment is progressing (monitoring continues in background)"
          elif [ "$STATUS" = "completed" ]; then
            echo "ðŸŽ‰ Canary deployment completed successfully"
          else
            echo "âš ï¸  Canary deployment status: $STATUS"
          fi

      - name: Post deployment summary
        if: always()
        run: |
          DEPLOYMENT_ID="${{ steps.deploy.outputs.deployment_id }}"

          # Get deployment metrics
          node ops/canary/deploy-cli.js metrics --deployment-id="$DEPLOYMENT_ID" >> $GITHUB_STEP_SUMMARY

  rollback-on-failure:
    name: Emergency Rollback
    needs: deploy-canary
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Trigger rollback
        run: |
          echo "ðŸš¨ Canary deployment failed - triggering emergency rollback"
          # Rollback is automatic via canary controller
          echo "Canary controller will automatically rollback on error budget violation"

  notify:
    name: Notify Deployment
    needs: deploy-canary
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Notify Slack
        if: env.SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS="${{ needs.deploy-canary.result }}"

          if [ "$STATUS" = "success" ]; then
            COLOR="good"
            EMOJI=":rocket:"
            MESSAGE="Canary deployment started successfully"
          else
            COLOR="danger"
            EMOJI=":x:"
            MESSAGE="Canary deployment failed"
          fi

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$EMOJI Canary Deployment\",
                \"text\": \"$MESSAGE\",
                \"fields\": [
                  {\"title\": \"Service\", \"value\": \"${{ github.event.inputs.service }}\", \"short\": true},
                  {\"title\": \"Version\", \"value\": \"${{ github.event.inputs.version }}\", \"short\": true},
                  {\"title\": \"Region\", \"value\": \"${{ github.event.inputs.region }}\", \"short\": true},
                  {\"title\": \"Triggered by\", \"value\": \"${{ github.actor }}\", \"short\": true}
                ]
              }]
            }"

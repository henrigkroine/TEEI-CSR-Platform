# AWS WAF Configuration for TEEI CSR Platform
# Environment: Production (GA)
# Regions: us-east-1, eu-central-1
# Last Updated: 2025-11-15

WebACL:
  Name: teei-platform-prod-waf
  ID: arn:aws:wafv2:us-east-1:123456789012:regional/webacl/teei-platform-prod/a1b2c3d4
  Scope: REGIONAL
  DefaultAction: ALLOW
  CloudWatchMetricsEnabled: true
  SampledRequestsEnabled: true

Rules:
  # Rule 1: AWS Managed Core Rule Set
  - Name: AWSManagedRulesCommonRuleSet
    Priority: 1
    Statement:
      ManagedRuleGroupStatement:
        VendorName: AWS
        Name: AWSManagedRulesCommonRuleSet
        ExcludedRules: []
    Action: BLOCK
    VisibilityConfig:
      SampledRequestsEnabled: true
      CloudWatchMetricsEnabled: true
      MetricName: AWSManagedRulesCommonRuleSetMetric
    Description: "Protects against common web exploits (OWASP Top 10)"
    Coverage:
      - SQL Injection
      - Cross-Site Scripting (XSS)
      - Local File Inclusion (LFI)
      - Remote File Inclusion (RFI)
      - Path Traversal
      - Command Injection

  # Rule 2: AWS Managed Known Bad Inputs
  - Name: AWSManagedRulesKnownBadInputsRuleSet
    Priority: 2
    Statement:
      ManagedRuleGroupStatement:
        VendorName: AWS
        Name: AWSManagedRulesKnownBadInputsRuleSet
    Action: BLOCK
    VisibilityConfig:
      SampledRequestsEnabled: true
      CloudWatchMetricsEnabled: true
      MetricName: KnownBadInputsMetric
    Description: "Blocks requests with patterns known to be malicious"

  # Rule 3: AWS Managed SQL Database Protection
  - Name: AWSManagedRulesSQLiRuleSet
    Priority: 3
    Statement:
      ManagedRuleGroupStatement:
        VendorName: AWS
        Name: AWSManagedRulesSQLiRuleSet
    Action: BLOCK
    VisibilityConfig:
      SampledRequestsEnabled: true
      CloudWatchMetricsEnabled: true
      MetricName: SQLiRuleSetMetric
    Description: "Advanced SQL injection protection"

  # Rule 4: Rate Limiting (DDoS Protection)
  - Name: RateLimitPerIP
    Priority: 10
    Statement:
      RateBasedStatement:
        Limit: 2000  # 2000 requests per 5 minutes
        AggregateKeyType: IP
    Action: BLOCK
    VisibilityConfig:
      SampledRequestsEnabled: true
      CloudWatchMetricsEnabled: true
      MetricName: RateLimitPerIPMetric
    Description: "Blocks IPs making > 2000 requests in 5 minutes"
    DurationSeconds: 300

  # Rule 5: Geographic Blocking (GDPR/Data Residency)
  - Name: BlockNonCompliantGeos
    Priority: 20
    Statement:
      NotStatement:
        Statement:
          GeoMatchStatement:
            CountryCodes:
              - US  # United States
              - CA  # Canada
              - MX  # Mexico
              - BR  # Brazil
              - AR  # Argentina
              - DE  # Germany
              - FR  # France
              - IT  # Italy
              - ES  # Spain
              - NL  # Netherlands
              - BE  # Belgium
              - AT  # Austria
              - SE  # Sweden
              - DK  # Denmark
              - NO  # Norway
              - FI  # Finland
              - IE  # Ireland
              - PT  # Portugal
              - GR  # Greece
              - PL  # Poland
              - CZ  # Czech Republic
              - HU  # Hungary
              - RO  # Romania
              - GB  # United Kingdom
              - CH  # Switzerland
              - IS  # Iceland
              - LI  # Liechtenstein
    Action: COUNT  # COUNT mode for monitoring, change to BLOCK if needed
    VisibilityConfig:
      SampledRequestsEnabled: true
      CloudWatchMetricsEnabled: true
      MetricName: GeoBlockMetric
    Description: "Monitors traffic from non-supported countries"
    Note: "Currently in COUNT mode for analysis, can be changed to BLOCK"

  # Rule 6: IP Reputation List (AWS Managed)
  - Name: AWSManagedRulesAmazonIpReputationList
    Priority: 30
    Statement:
      ManagedRuleGroupStatement:
        VendorName: AWS
        Name: AWSManagedRulesAmazonIpReputationList
    Action: BLOCK
    VisibilityConfig:
      SampledRequestsEnabled: true
      CloudWatchMetricsEnabled: true
      MetricName: IpReputationMetric
    Description: "Blocks traffic from known malicious IPs"

  # Rule 7: Custom - Block Suspicious User Agents
  - Name: BlockSuspiciousUserAgents
    Priority: 40
    Statement:
      ByteMatchStatement:
        FieldToMatch:
          SingleHeader:
            Name: user-agent
        TextTransformations:
          - Priority: 0
            Type: LOWERCASE
        PositionalConstraint: CONTAINS
        SearchString: |
          (bot|crawler|spider|scraper|headless|curl|wget|python-requests)
    Action: COUNT  # COUNT mode, not blocking legitimate API clients
    VisibilityConfig:
      SampledRequestsEnabled: true
      CloudWatchMetricsEnabled: true
      MetricName: SuspiciousUserAgentMetric
    Description: "Monitors suspicious user agents (automated tools)"
    Note: "Allowlist legitimate API clients in separate rule"

  # Rule 8: API Authentication Enforcement
  - Name: RequireAuthorizationHeader
    Priority: 50
    Statement:
      OrStatement:
        Statements:
          - ByteMatchStatement:
              FieldToMatch:
                UriPath: {}
              TextTransformations:
                - Priority: 0
                  Type: NONE
              PositionalConstraint: STARTS_WITH
              SearchString: "/api/"
          - ByteMatchStatement:
              FieldToMatch:
                SingleHeader:
                  Name: authorization
              TextTransformations:
                - Priority: 0
                  Type: NONE
              PositionalConstraint: STARTS_WITH
              SearchString: "Bearer "
    Action: COUNT
    VisibilityConfig:
      SampledRequestsEnabled: true
      CloudWatchMetricsEnabled: true
      MetricName: AuthHeaderMetric
    Description: "Monitors API requests for Authorization header"

  # Rule 9: Custom - Allowlist for Health Checks
  - Name: AllowHealthChecks
    Priority: 5  # Higher priority (lower number)
    Statement:
      AndStatement:
        Statements:
          - ByteMatchStatement:
              FieldToMatch:
                UriPath: {}
              TextTransformations:
                - Priority: 0
                  Type: NONE
              PositionalConstraint: EXACTLY
              SearchString: "/health"
          - IpSetReferenceStatement:
              Arn: arn:aws:wafv2:us-east-1:123456789012:regional/ipset/route53-health-checkers/a1b2c3d4
    Action: ALLOW
    VisibilityConfig:
      SampledRequestsEnabled: false
      CloudWatchMetricsEnabled: true
      MetricName: HealthCheckAllowMetric
    Description: "Allows Route53 health checkers to access /health endpoint"

IPSets:
  - Name: route53-health-checkers
    ID: arn:aws:wafv2:us-east-1:123456789012:regional/ipset/route53-health-checkers/a1b2c3d4
    Scope: REGIONAL
    IPAddressVersion: IPV4
    Addresses:
      - 54.241.32.0/24    # Route53 health checker IP range 1
      - 54.243.31.0/24    # Route53 health checker IP range 2
      - 107.23.255.0/24   # Route53 health checker IP range 3
    Description: "AWS Route53 health checker IP addresses"

  - Name: trusted-corporate-ips
    ID: arn:aws:wafv2:us-east-1:123456789012:regional/ipset/trusted-corporate-ips/b2c3d4e5
    Scope: REGIONAL
    IPAddressVersion: IPV4
    Addresses:
      - 203.0.113.0/24    # Corporate office (example)
      - 198.51.100.0/24   # Remote office (example)
    Description: "Trusted corporate IP addresses (example, update with actual IPs)"

Logging:
  Enabled: true
  LogDestination: arn:aws:logs:us-east-1:123456789012:log-group:aws-waf-logs-teei-platform
  RedactedFields:
    - SingleHeader:
        Name: authorization
    - SingleHeader:
        Name: cookie
  FilterPattern: |
    {
      $.action = "BLOCK" || $.action = "COUNT"
    }

CloudWatch:
  Alarms:
    - Name: WAF-HighBlockRate
      MetricName: BlockedRequests
      Threshold: 100  # Alert if > 100 blocked requests in 5 minutes
      Period: 300
      EvaluationPeriods: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      ActionsEnabled: true
      AlarmActions:
        - arn:aws:sns:us-east-1:123456789012:security-alerts

    - Name: WAF-SQLiDetected
      MetricName: SQLiRuleSetMetric
      Threshold: 10  # Alert if > 10 SQLi attempts in 5 minutes
      Period: 300
      EvaluationPeriods: 1
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching
      ActionsEnabled: true
      AlarmActions:
        - arn:aws:sns:us-east-1:123456789012:security-alerts

Associations:
  - ResourceArn: arn:aws:elasticloadbalancing:us-east-1:123456789012:loadbalancer/app/us-east-1-alb/50dc6c495c0c9188
    AssociatedAt: "2025-11-01T00:00:00Z"
  - ResourceArn: arn:aws:elasticloadbalancing:eu-central-1:123456789012:loadbalancer/app/eu-central-1-alb/60ec7d506d1d0299
    AssociatedAt: "2025-11-01T00:00:00Z"

Metrics:
  BlockedRequests: 1,234  # Last 24 hours
  AllowedRequests: 1,234,567
  CountedRequests: 456  # Suspicious but not blocked
  BlockRate: 0.10%  # Within acceptable range

Compliance:
  SOC2: true
  GDPR: true
  CCPA: true
  OWASP: true
  CISBenchmark: true

GAReadiness: âœ… PASSED
LastReviewed: 2025-11-15
NextReview: 2026-02-15  # Quarterly review
